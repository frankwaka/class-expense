<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ MUJI Design Tokens â”€â”€ */
:root {
  --bg: #F5F0EB;
  --bg-warm: #EDE6DE;
  --card: #FEFCFA;
  --card-hover: #FBF8F4;
  --accent: #C67B4B;
  --accent-light: #F5E6D8;
  --accent-dark: #A0613A;
  --accent-soft: #D9A67E;
  --text: #3D3530;
  --text-soft: #7A6E65;
  --text-muted: #B0A69C;
  --border: #E5DDD4;
  --border-light: #EDE6DE;
  --paid: #6A9B6A;
  --paid-bg: #EDF5ED;
  --unpaid: #C4645A;
  --unpaid-bg: #FAEDEB;
  --highlight: #FFF8F0;
  --shadow-sm: 0 1px 3px rgba(80,60,40,.04);
  --shadow: 0 2px 8px rgba(80,60,40,.06);
  --shadow-md: 0 4px 16px rgba(80,60,40,.07);
  --shadow-lg: 0 8px 30px rgba(80,60,40,.1);
  --radius: 16px;
  --radius-sm: 12px;
  --radius-xs: 10px;
  --cherry: #B8705A;
  --cherry-bg: #F8EDE8;
  --koelr: #7A9A5E;
  --koelr-bg: #EFF4EA;
  --cotton: #C08A56;
  --cotton-bg: #F7EEE3;
  --maple: #B05E52;
  --maple-bg: #F5E9E6;
  --transition: .22s cubic-bezier(.4,0,.2,1);
  --font-num: 'DM Sans', sans-serif;
}

/* â”€â”€ Reset â”€â”€ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

/* â”€â”€ Body â”€â”€ */
body {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
}

/* â”€â”€ Header â”€â”€ */
.header {
  background: var(--accent);
  padding: 3rem 1.5rem 2.5rem;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,.1) 0%, transparent 50%, rgba(0,0,0,.05) 100%);
  pointer-events: none;
}
.header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-dark), var(--accent-soft), var(--accent-dark));
}
.header-inner {
  position: relative;
}
.header-badge {
  display: inline-flex;
  align-items: center;
  font-size: .65rem;
  font-weight: 500;
  letter-spacing: 2px;
  color: rgba(255,255,255,.7);
  margin-bottom: .9rem;
  text-transform: uppercase;
}
.header h1 {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 2rem;
  font-weight: 500;
  letter-spacing: 4px;
  color: #fff;
  margin-bottom: .5rem;
}
.header p {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: .95rem;
  color: rgba(255,255,255,.75);
  font-weight: 400;
  letter-spacing: 1px;
}

/* â”€â”€ Container â”€â”€ */
.container {
  max-width: 520px;
  margin: 0 auto;
  padding: 1.5rem 1rem 3rem;
}

/* â”€â”€ Search Section â”€â”€ */
.search-section {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.3rem;
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-light);
}
.search-label {
  font-size: .68rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: .65rem;
  letter-spacing: 1.5px;
  text-transform: uppercase;
}
.search-row {
  display: flex;
  gap: .6rem;
}
.search-wrapper {
  position: relative;
  flex: 1;
}
.search-wrapper input {
  width: 100%;
  padding: .9rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: 1.05rem;
  font-family: inherit;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
}
.search-wrapper input::placeholder {
  color: var(--text-muted);
  font-weight: 300;
}
.search-wrapper input:focus {
  border-color: var(--accent-soft);
  box-shadow: 0 0 0 3px rgba(198,123,75,.1);
  background: var(--card);
}
.search-wrapper input:disabled {
  opacity: .45;
  cursor: not-allowed;
}
.btn-search {
  padding: .8rem 1.5rem;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: .85rem;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition), transform .12s, box-shadow var(--transition);
  white-space: nowrap;
  letter-spacing: 1px;
}
.btn-search:hover:not(:disabled) {
  background: var(--accent-dark);
  box-shadow: 0 2px 8px rgba(160,97,58,.2);
}
.btn-search:active:not(:disabled) { transform: scale(.97); }
.btn-search:disabled { opacity: .4; cursor: not-allowed; }

/* â”€â”€ Autocomplete â”€â”€ */
.autocomplete-list {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  max-height: 220px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: var(--shadow-lg);
}
.autocomplete-list.show { display: block; }
.ac-item {
  padding: .65rem 1rem;
  cursor: pointer;
  font-size: .86rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background var(--transition);
  border-bottom: 1px solid var(--border-light);
}
.ac-item:last-child { border-bottom: none; }
.ac-item:first-child { border-radius: 11px 11px 0 0; }
.ac-item:last-child { border-radius: 0 0 11px 11px; }
.ac-item:only-child { border-radius: 11px; }
.ac-item:hover { background: var(--accent-light); }
.ac-item .seat {
  color: var(--text-muted);
  font-size: .72rem;
  font-weight: 500;
}

/* â”€â”€ Scrollbar â”€â”€ */
.autocomplete-list::-webkit-scrollbar { width: 3px; }
.autocomplete-list::-webkit-scrollbar-track { background: transparent; }
.autocomplete-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ Hint â”€â”€ */
.hint {
  text-align: center;
  padding: 3.5rem 1rem;
  color: var(--text-soft);
}
.hint-icon {
  font-size: 2rem;
  margin-bottom: .8rem;
  opacity: .25;
}
.hint p {
  font-size: .84rem;
  line-height: 1.9;
  color: var(--text-muted);
  font-weight: 300;
}

/* â”€â”€ Student Card â”€â”€ */
.student-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  animation: slideUp .4s cubic-bezier(.4,0,.2,1);
  margin-bottom: 1.2rem;
  border: 1px solid var(--border-light);
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.student-header {
  padding: 1.2rem 1.4rem;
  background: var(--accent);
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.student-header::before {
  display: none;
}
.student-name {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 1.5rem;
  font-weight: 400;
  letter-spacing: 2px;
}
.student-seat {
  font-size: .7rem;
  font-weight: 500;
  background: rgba(255,255,255,.18);
  padding: .25rem .75rem;
  border-radius: 20px;
  letter-spacing: .5px;
}

/* â”€â”€ Total Banner â”€â”€ */
.total-banner {
  background: var(--highlight);
  padding: 1rem 1.4rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border-light);
}
.total-banner .label {
  font-size: .78rem;
  color: var(--text-soft);
  font-weight: 400;
  letter-spacing: .3px;
}
.total-banner .amount {
  font-family: var(--font-num);
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-dark);
  letter-spacing: -.5px;
}
.pay-btn-wrap {
  padding: .8rem 1.4rem;
  border-bottom: 1px solid var(--border-light);
  text-align: center;
}
.pay-btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .7rem 1.8rem;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: .9rem;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  letter-spacing: 1px;
  transition: background var(--transition), transform .12s, box-shadow var(--transition);
  box-shadow: 0 2px 8px rgba(160,97,58,.18);
}
.pay-btn:hover {
  background: var(--accent-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(160,97,58,.25);
}
.pay-btn:active { transform: translateY(0); }

/* â”€â”€ Grade Headers â”€â”€ */
.grade-section {}
.grade-header {
  padding: .7rem 1.4rem;
  font-size: .72rem;
  font-weight: 600;
  letter-spacing: 1.5px;
  display: flex;
  align-items: center;
  gap: .5rem;
  border-bottom: 1px solid var(--border-light);
  text-transform: uppercase;
}
.grade-header.cherry { background: var(--cherry-bg); color: var(--cherry); }
.grade-header.koelr  { background: var(--koelr-bg);  color: var(--koelr); }
.grade-header.cotton { background: var(--cotton-bg); color: var(--cotton); }
.grade-header.maple  { background: var(--maple-bg);  color: var(--maple); }
.grade-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}
.grade-dot.cherry { background: var(--cherry); }
.grade-dot.koelr  { background: var(--koelr); }
.grade-dot.cotton { background: var(--cotton); }
.grade-dot.maple  { background: var(--maple); }
.grade-subtotal {
  margin-left: auto;
  font-family: var(--font-num);
  font-size: .8rem;
  font-weight: 600;
}

/* â”€â”€ Season Groups â”€â”€ */
.season-group {
  border-bottom: 1px solid var(--border-light);
}
.season-group:last-child { border-bottom: none; }
.season-header {
  padding: .75rem 1.4rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background var(--transition);
  user-select: none;
}
.season-header:hover { background: var(--card-hover); }
.season-title {
  font-weight: 500;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: .45rem;
  color: var(--text);
}
.season-icon { font-size: .9rem; }
.season-right {
  display: flex;
  align-items: center;
  gap: .5rem;
}
.season-total {
  font-family: var(--font-num);
  font-weight: 600;
  font-size: .88rem;
  color: var(--accent);
}
.season-paid {
  display: inline-flex;
  align-items: center;
  font-size: .62rem;
  font-weight: 600;
  padding: .18rem .55rem;
  border-radius: 20px;
  letter-spacing: .3px;
}
.paid-yes {
  background: var(--paid-bg);
  color: var(--paid);
}
.paid-no {
  background: var(--unpaid-bg);
  color: var(--unpaid);
}
.chevron {
  font-size: .5rem;
  transition: transform .25s cubic-bezier(.4,0,.2,1);
  color: var(--text-muted);
  margin-left: .1rem;
}
.chevron.open { transform: rotate(180deg); }

/* â”€â”€ Season Details â”€â”€ */
.season-details {
  padding: 0 1.4rem .75rem;
  display: none;
  padding-left: 2.8rem;
}
.season-details.open { display: block; }
.course-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: .5rem 0;
  border-bottom: 1px solid var(--border-light);
  font-size: .95rem;
}
.course-row:last-child { border-bottom: none; }
.course-name {
  color: var(--text-soft);
  font-weight: 400;
}
.course-amount {
  font-family: var(--font-num);
  font-weight: 600;
  min-width: 55px;
  text-align: right;
  color: var(--text);
}
.no-course {
  color: var(--text-muted);
  font-size: .82rem;
  padding: .4rem 0;
  font-weight: 300;
}

/* â”€â”€ Error â”€â”€ */
.error-msg {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--unpaid);
  animation: slideUp .35s cubic-bezier(.4,0,.2,1);
}
.error-msg .icon { font-size: 2rem; margin-bottom: .7rem; }
.error-msg p { font-size: .86rem; font-weight: 400; }

/* â”€â”€ Footer â”€â”€ */
.footer {
  text-align: center;
  padding: 2rem 1rem 1rem;
  color: var(--text-muted);
  font-size: .65rem;
  letter-spacing: 1.5px;
  font-weight: 300;
}

/* â”€â”€ Loading â”€â”€ */
.loading {
  text-align: center;
  padding: 3.5rem 1rem;
  color: var(--text-soft);
}
.loading-spinner {
  width: 28px;
  height: 28px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto 1rem;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading p { font-size: .82rem; color: var(--text-muted); font-weight: 300; }

/* â”€â”€ Status Bar â”€â”€ */
.status-bar {
  background: var(--card);
  border-radius: var(--radius-xs);
  padding: .6rem 1rem;
  margin-bottom: 1rem;
  font-size: .7rem;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
  font-weight: 400;
}
.status-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  display: inline-block;
  margin-right: .35rem;
}
.status-dot.ok  { background: var(--paid); }
.status-dot.err { background: var(--unpaid); }

/* â”€â”€ Mobile First â”€â”€ */
@media (max-width: 480px) {
  .header { padding: 2.5rem 1.2rem 2rem; }
  .header h1 { font-size: 1.3rem; letter-spacing: 1.5px; }
  .container { padding: 1.2rem .75rem 2.5rem; }
  .search-section { padding: 1.1rem; }
  .search-row { flex-direction: column; gap: .5rem; }
  .search-wrapper { width: 100%; }
  .btn-search { width: 100%; padding: .85rem; font-size: .88rem; }
  .season-details { padding-left: 2.2rem; }
  .student-header { padding: 1rem 1.2rem; }
  .total-banner { padding: .85rem 1.2rem; }
  .grade-header { padding: .65rem 1.2rem; }
  .season-header { padding: .7rem 1.2rem; }
}

@media (min-width: 481px) and (max-width: 768px) {
  .container { padding: 1.3rem .9rem 2.5rem; }
}

/* â”€â”€ Payment Modal â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(61,53,48,.45);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  animation: fadeIn .2s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal {
  background: var(--card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: modalUp .3s cubic-bezier(.4,0,.2,1);
}
@keyframes modalUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
.modal-header {
  padding: 1.2rem 1.4rem;
  background: var(--accent);
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: var(--radius) var(--radius) 0 0;
}
.modal-header h2 {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 1.1rem;
  font-weight: 500;
  letter-spacing: 1px;
}
.modal-close {
  background: rgba(255,255,255,.2);
  border: none;
  color: #fff;
  width: 30px; height: 30px;
  border-radius: 50%;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background var(--transition);
}
.modal-close:hover { background: rgba(255,255,255,.35); }
.modal-body { padding: 1.3rem 1.4rem; }
.modal-step { display: none; }
.modal-step.active { display: block; }

/* Pay info cards - side by side */
.pay-methods-row {
  display: flex;
  gap: .8rem;
  margin-bottom: .8rem;
}
.pay-info-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem 1rem;
  flex: 1;
  min-width: 0;
}
.pay-info-card .card-title {
  font-size: .68rem;
  font-weight: 600;
  color: var(--text-muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: .6rem;
}
.pay-info-row {
  padding: .25rem 0;
  font-size: .78rem;
}
.pay-info-row .lbl { color: var(--text-soft); font-weight: 400; }
.pay-info-row .val { font-weight: 600; color: var(--text); letter-spacing: .3px; display: block; }
.pay-info-row .val.mono { font-family: var(--font-num); font-size: .72rem; word-break: break-all; }
@media (max-width: 480px) {
  .pay-methods-row { flex-direction: column; }
}
.pay-deadline {
  text-align: center;
  padding: .8rem;
  margin: .8rem 0;
  background: var(--unpaid-bg);
  border-radius: var(--radius-xs);
  font-size: .85rem;
  color: var(--unpaid);
  font-weight: 500;
}

/* Form fields */
.form-group { margin-bottom: 1rem; }
.form-label {
  display: block;
  font-size: .78rem;
  font-weight: 500;
  color: var(--text-soft);
  margin-bottom: .4rem;
}
.form-input, .form-select {
  width: 100%;
  padding: .8rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: .95rem;
  font-family: inherit;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent-soft);
  box-shadow: 0 0 0 3px rgba(198,123,75,.1);
}
.form-input:disabled { opacity: .5; }
.form-hint {
  font-size: .72rem;
  color: var(--text-muted);
  margin-top: .3rem;
  line-height: 1.5;
}
.form-input.readonly-info {
  background: var(--accent-light);
  border-color: var(--accent-soft);
  color: var(--text);
  font-weight: 500;
}
.linepay-note {
  background: var(--koelr-bg);
  border: 1px solid #c5d8b3;
  border-radius: var(--radius-xs);
  padding: .8rem 1rem;
  font-size: .82rem;
  color: var(--koelr);
  line-height: 1.6;
  margin-bottom: 1rem;
}

/* Buttons */
.btn-primary {
  width: 100%;
  padding: .85rem;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: .9rem;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  letter-spacing: 1px;
  transition: background var(--transition), transform .12s;
}
.btn-primary:hover:not(:disabled) { background: var(--accent-dark); }
.btn-primary:active:not(:disabled) { transform: scale(.98); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }
.btn-outline {
  width: 100%;
  padding: .75rem;
  background: transparent;
  color: var(--text-soft);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: .82rem;
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  margin-top: .5rem;
  transition: background var(--transition), border-color var(--transition);
}
.btn-outline:hover { background: var(--bg); border-color: var(--text-muted); }

/* Success screen */
.success-screen {
  text-align: center;
  padding: 1.5rem 0;
}
.success-icon {
  font-size: 3rem;
  margin-bottom: .8rem;
}
.success-screen h3 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--paid);
  margin-bottom: .4rem;
}
.success-screen p {
  font-size: .85rem;
  color: var(--text-soft);
  line-height: 1.6;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-badge">ELECTIVE FEE</div>
    <h1>é¸ä¿®è²»ç”¨æŸ¥è©¢</h1>
    <p>è¼¸å…¥å°æœ‹å‹çš„å§“åæˆ–åº§è™ŸæŸ¥çœ‹è²»ç”¨æ˜ç´°</p>
  </div>
</div>

<div class="container">
  <div class="search-section">
    <div class="search-label">æœå°‹å­¸ç”Ÿ</div>
    <div class="search-row">
      <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="å§“åæˆ–åº§è™Ÿ..." autocomplete="off" disabled>
        <div class="autocomplete-list" id="autocomplete"></div>
      </div>
      <button class="btn-search" onclick="doSearch()" disabled id="searchBtn">æŸ¥ è©¢</button>
    </div>
  </div>
  <div id="results">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
    </div>
  </div>
</div>

<div class="footer">ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±</div>

<script>
// ============================================================
// â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
// ============================================================
const SHEET_ID = '1Gqea_tTq_-Mvd8LfLbDKu9T5zB_vWB5pbQiYDgMidGE';
const SHEET_NAME = 'é¸ä¿®è²»';

// â˜… ç¹³è²»å›å ± Apps Script ç¶²å€ï¼ˆéƒ¨ç½²å¾Œè²¼åœ¨é€™è£¡ï¼‰
const SCRIPT_URL = 'åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Apps Script ç¶²å€';

// â˜… ç¹³è²»è³‡è¨Šï¼ˆæ¯å­¸å­£æ›´æ–°é€™è£¡å°±å¥½ï¼‰
const PAY_INFO = {
  bank: 'å°åŒ—å¯Œé‚¦ 012',
  branch: 'èŠæ•¬åˆ†è¡Œ',
  account: '00461168191348',
  accountName: 'æˆ´ä¾ä¾',
  linePayUrl: 'https://line.me/ti/p/7BYZ9G-oeF',
  linePay: 'è«‹å…ˆåŠ ã€Œæˆ´ä¾ä¾ã€ç‚ºå¥½å‹ï¼Œä¸¦å‘ŠçŸ¥æ˜¯å¹¾è™Ÿçš„å®¶é•·',
  deadline: '12/5',
};

// å·²å…¨éƒ¨ç¹³æ¸…çš„å­¸å­£ï¼ˆæ ¼å¼ï¼šã€Œå¹´ç´šå-å­¸å­£åã€ï¼‰
// é€™äº›å­¸å­£æ‰€æœ‰å­¸ç”Ÿéƒ½æœƒé¡¯ç¤ºã€Œå·²ç¹³ã€ï¼Œä¸éœ€è¦åœ¨è©¦ç®—è¡¨æ¨™è¨˜
const PAID_SEASONS = [
  "å±±æ«»ç­-ç§‹å­¸å­£",
  "å±±æ«»ç­-å†¬å­¸å­£",
  "å±±æ«»ç­-æ˜¥å­¸å­£",
  "å±±æ«»ç­-å¤å­¸å­£",
  "æ¬’æ¨¹ç­-ç§‹å­¸å­£",
  // "æ¬’æ¨¹ç­-å†¬å­¸å­£",  â† ç›®å‰é€™å­¸å­£ï¼Œé‚„æ²’ç¹³æ¸…æ‰€ä»¥ä¸åŠ 
];

// å¹´ç´šè¨­å®šï¼šç”¨æ¬„ä½å‰ç¶´ä¾†å€åˆ†å“ªäº›æ¬„å±¬æ–¼å“ªå€‹å¹´ç´š
// prefix: è©¦ç®—è¡¨æ¬„ä½é–‹é ­æ˜¯é€™äº›å­—çš„ï¼Œå°±æ­¸åˆ°é€™å€‹å¹´ç´š
const GRADE_CONFIG = [
  { name:"å±±æ«»ç­", grade:"ä¸‰å¹´ç´š", colorClass:"cherry",
    prefixes:["å±±ç§‹","å±±å†¬","å±±æ˜¥","å±±å¤","å±±æ«»"] },
  { name:"æ¬’æ¨¹ç­", grade:"å››å¹´ç´š", colorClass:"koelr",
    prefixes:["æ¬’ç§‹","æ¬’å†¬","æ¬’æ¨¹","æ¬’æ˜¥","æ¬’å¤"] },
  // æœªä¾†æ–°å¢ï¼ˆæŠŠè¨»è§£æ‹¿æ‰å°±å¥½ï¼‰ï¼š
  // { name:"æœ¨æ£‰ç­", grade:"äº”å¹´ç´š", colorClass:"cotton",
  //   prefixes:["æœ¨ç§‹","æœ¨å†¬","æœ¨æ˜¥","æœ¨å¤","æœ¨æ£‰"] },
  // { name:"æ¥“é¦™ç­", grade:"å…­å¹´ç´š", colorClass:"maple",
  //   prefixes:["æ¥“ç§‹","æ¥“å†¬","æ¥“æ˜¥","æ¥“å¤","æ¥“é¦™"] },
];
// ============================================================

const SEASON_MAP = {"ç§‹":"ğŸ‚","å†¬":"â„ï¸","æ˜¥":"ğŸŒ¸","å¤":"â˜€ï¸"};
function getSeasonIcon(name) {
  for (const [k,v] of Object.entries(SEASON_MAP)) { if (name.includes(k)) return v; }
  return "ğŸ“˜";
}

// åˆ¤æ–·ä¸€å€‹æ¬„ä½å±¬æ–¼å“ªå€‹å¹´ç´š
function matchGrade(colName) {
  // ä¾ prefix é•·åº¦ç”±é•·åˆ°çŸ­æ¯”å°ï¼Œé¿å…ã€Œç§‹ã€èª¤é…ã€Œæ¬’ç§‹ã€
  for (const g of [...GRADE_CONFIG].sort((a,b) => {
    const maxA = Math.max(...a.prefixes.map(p=>p.length));
    const maxB = Math.max(...b.prefixes.map(p=>p.length));
    return maxB - maxA;
  })) {
    for (const p of g.prefixes.sort((a,b)=>b.length-a.length)) {
      if (colName.startsWith(p)) return g;
    }
  }
  return null;
}

// å¾æ¬„ä½ååˆ¤æ–·å­£ç¯€å
function getSeasonName(colName, gradeConfig) {
  // "æ¬’ç§‹-æ‰‹ä½œ" â†’ æ‰¾åˆ° prefix "æ¬’ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "æ˜¥-ç¥è¾²æ°" â†’ å­£ç¯€æ˜¯ "æ˜¥å­¸å­£"
  for (const p of gradeConfig.prefixes.sort((a,b)=>b.length-a.length)) {
    if (colName.startsWith(p)) {
      // å–å‡ºå­£ç¯€å­—ï¼šæœ€å¾Œä¸€å€‹å­—
      const lastChar = p.slice(-1);
      for (const s of Object.keys(SEASON_MAP)) {
        if (lastChar === s || p.includes(s)) return s + "å­¸å­£";
      }
      return p + "å­¸å­£";
    }
  }
  return "å…¶ä»–";
}

// å–å¾—èª²ç¨‹é¡¯ç¤ºåç¨±
function getCourseName(colName) {
  const dash = colName.indexOf('-');
  if (dash >= 0) return colName.substring(dash + 1);
  return colName + "é¸ä¿®";
}

let allStudents = [];
let dataReady = false;

// å¾ã€Œç¹³è²»å›å ±ã€é ç±¤ G1 è®€å–ç¹³è²»æˆªæ­¢æ—¥
async function fetchDeadline() {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent('ç¹³è²»å›å ±')}&range=G1`;
    const res = await fetch(url);
    const text = await res.text();
    const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
    if (jsonStr) {
      const json = JSON.parse(jsonStr[1]);
      const val = json.table?.rows?.[0]?.c?.[0]?.v;
      if (val) PAY_INFO.deadline = String(val).trim();
    }
  } catch (e) {
    // è®€ä¸åˆ°å°±ç”¨é è¨­å€¼ï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½
  }
}

async function fetchSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
  if (!jsonStr) throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨è³‡æ–™ï¼Œè«‹ç¢ºèªåˆ†äº«è¨­å®š');
  return JSON.parse(jsonStr[1]);
}

function parseData(json) {
  const cols = json.table.cols.map(c => (c.label || '').trim());
  const rows = json.table.rows;

  const seatIdx = cols.findIndex(c => c.includes('åº§è™Ÿ'));
  const nameIdx = cols.findIndex(c => c.includes('å§“å'));
  if (seatIdx === -1 || nameIdx === -1) throw new Error('æ‰¾ä¸åˆ°ã€Œåº§è™Ÿã€æˆ–ã€Œå§“åã€æ¬„ä½');

  // åˆ†ææ¯å€‹æ¬„ä½æ­¸å±¬
  // colInfo[i] = { grade, seasonName, courseName, isPaid, colIdx }
  const colInfos = [];
  let lastDataCol = null; // è¿½è¹¤ã€Œå·²ç¹³æ¬¾ã€å°æ‡‰çš„å‰ä¸€å€‹è³‡æ–™æ¬„

  for (let i = 0; i < cols.length; i++) {
    const col = cols[i];
    if (i === seatIdx || i === nameIdx || !col) continue;

    if (col === 'å·²ç¹³æ¬¾') {
      // æ¨™è¨˜å‰ä¸€å€‹å­¸å­£çš„ paid æ¬„ä½
      if (lastDataCol) lastDataCol.paidIdx = i;
      continue;
    }
    if (col.includes('ç¸½é¡') || col.includes('é¸ä¿®è²»')) {
      continue; // è·³éå°è¨ˆæ¬„
    }

    const grade = matchGrade(col);
    if (!grade) continue;

    const seasonName = getSeasonName(col, grade);
    const courseName = getCourseName(col);

    const info = { grade: grade, seasonName, courseName, colIdx: i, paidIdx: -1 };
    colInfos.push(info);
    lastDataCol = info;
  }

  // çµ„ç¹”æˆ grade â†’ season â†’ courses çµæ§‹
  const students = [];

  for (const row of rows) {
    const cells = row.c || [];
    const seatVal = cells[seatIdx]?.v;
    const nameVal = cells[nameIdx]?.v;
    if (!seatVal || !nameVal) continue;
    if (typeof seatVal === 'string' && seatVal.includes('å…¥ç­è²»')) continue;
    const seat = Math.round(Number(seatVal));
    if (isNaN(seat)) continue;

    // å»ºç«‹æ¯å€‹å¹´ç´šçš„è³‡æ–™
    const grades = [];
    for (const gc of GRADE_CONFIG) {
      const myCols = colInfos.filter(c => c.grade === gc);
      if (myCols.length === 0) continue;

      // åˆ†çµ„æˆå­¸å­£
      const seasonMap = {};
      for (const ci of myCols) {
        if (!seasonMap[ci.seasonName]) {
          seasonMap[ci.seasonName] = { name: ci.seasonName, icon: getSeasonIcon(ci.seasonName), courses: [], paidIdx: -1 };
        }
        const amount = Number(cells[ci.colIdx]?.v) || 0;
        seasonMap[ci.seasonName].courses.push({ label: ci.courseName, amount });
        if (ci.paidIdx >= 0) seasonMap[ci.seasonName].paidIdx = ci.paidIdx;
      }

      const seasons = Object.values(seasonMap).map(sn => {
        const total = sn.courses.reduce((a, c) => a + c.amount, 0);
        const paid = sn.paidIdx >= 0 ? (cells[sn.paidIdx]?.v === 'v' ? 'v' : '') : null;
        return { ...sn, total, paid };
      });

      grades.push({ name: gc.name, grade: gc.grade, colorClass: gc.colorClass, seasons });
    }

    students.push({ seat, name: nameVal, grades });
  }

  return students;
}

async function loadAllData() {
  const resultsDiv = document.getElementById('results');
  try {
    const json = await fetchSheet();
    allStudents = parseData(json);
    dataReady = true;
    await fetchDeadline(); // å¾è©¦ç®—è¡¨è®€å–æˆªæ­¢æ—¥

    document.getElementById('searchInput').disabled = false;
    document.getElementById('searchBtn').disabled = false;

    const now = new Date();
    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

    resultsDiv.innerHTML = `
      <div class="status-bar"><span><span class="status-dot ok"></span>è³‡æ–™å·²è¼‰å…¥ï¼ˆ${allStudents.length} ä½å­¸ç”Ÿï¼‰</span><span>æ›´æ–°ï¼š${timeStr}</span></div>
      <div class="hint"><div class="hint-icon">ğŸ”</div><p>è¼¸å…¥å°æœ‹å‹çš„å§“åæˆ–åº§è™Ÿ<br>å³å¯æŸ¥çœ‹å„å­¸å­£çš„é¸ä¿®è²»ç”¨æ˜ç´°</p></div>`;
  } catch (err) {
    resultsDiv.innerHTML = `
      <div class="error-msg"><div class="icon">âš ï¸</div>
        <p>è¼‰å…¥è³‡æ–™å¤±æ•—</p>
        <p style="margin-top:.8rem;font-size:.82rem;line-height:1.6">è«‹ç¢ºèªï¼š<br>1. è©¦ç®—è¡¨å·²è¨­å®šã€ŒçŸ¥é“é€£çµçš„äººå¯ä»¥æª¢è¦–ã€<br>2. é ç±¤åç¨±ç‚ºã€Œ${SHEET_NAME}ã€</p>
        <p style="margin-top:.8rem;font-size:.75rem;color:#bbb">${err.message}</p>
      </div>`;
  }
}

// === æœå°‹ ===
const searchInput = document.getElementById('searchInput');
const acList = document.getElementById('autocomplete');
const resultsDiv = document.getElementById('results');

searchInput.addEventListener('input', () => {
  if (!dataReady) return;
  const q = searchInput.value.trim();
  if (!q) { acList.classList.remove('show'); return; }
  const m = allStudents.filter(x => x.name.includes(q) || String(x.seat) === q || String(x.seat).startsWith(q)).slice(0, 8);
  if (!m.length) { acList.classList.remove('show'); return; }
  acList.innerHTML = m.map(x => `<div class="ac-item" data-seat="${x.seat}" data-name="${x.name}"><span>${x.name}</span><span class="seat">åº§è™Ÿ ${x.seat}</span></div>`).join('');
  acList.classList.add('show');
});

acList.addEventListener('click', e => {
  const item = e.target.closest('.ac-item');
  if (!item) return;
  searchInput.value = item.dataset.name;
  acList.classList.remove('show');
  const x = allStudents.find(s => s.seat === Number(item.dataset.seat) && s.name === item.dataset.name);
  if (x) render(x);
});

searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
document.addEventListener('click', e => { if (!e.target.closest('.search-wrapper')) acList.classList.remove('show'); });

function doSearch() {
  if (!dataReady) return;
  acList.classList.remove('show');
  const q = searchInput.value.trim();
  if (!q) return;
  const x = allStudents.find(s => s.name === q || String(s.seat) === q) || allStudents.find(s => s.name.includes(q));
  if (x) render(x);
  else resultsDiv.innerHTML = `<div class="error-msg"><div class="icon">ğŸ˜•</div><p>æ‰¾ä¸åˆ°ã€Œ${q}ã€ï¼Œè«‹ç¢ºèªå§“åæˆ–åº§è™Ÿ</p></div>`;
}

function render(x) {
  let gt = 0;
  const html = x.grades.map(g => {
    let gTotal = 0;
    const shtml = g.seasons.map(sn => {
      const active = sn.courses.filter(c => c.amount > 0);
      gTotal += sn.total; gt += sn.total;
      const seasonKey = g.name + '-' + sn.name;
      const forcePaid = PAID_SEASONS.includes(seasonKey);
      const isPaid = forcePaid || sn.paid === 'v';
      const showPaidTag = sn.total > 0 ? (isPaid ? '<span class="season-paid paid-yes">âœ“ å·²ç¹³</span>' : '<span class="season-paid paid-no">æœªç¹³</span>') : '';
      return `<div class="season-group"><div class="season-header" onclick="tog(this)"><div class="season-title"><span class="season-icon">${sn.icon}</span>${sn.name}${showPaidTag}</div><div class="season-right"><span class="season-total">${sn.total > 0 ? '$' + sn.total.toLocaleString() : '-'}</span><span class="chevron">â–¼</span></div></div><div class="season-details">${active.length > 0 ? active.map(c => `<div class="course-row"><span class="course-name">${c.label}</span><span class="course-amount">$${c.amount.toLocaleString()}</span></div>`).join('') : '<div class="no-course">æœ¬å­¸å­£ç„¡é¸ä¿®è²»ç”¨</div>'}</div></div>`;
    }).join('');
    return `<div class="grade-section"><div class="grade-header ${g.colorClass}"><span class="grade-dot ${g.colorClass}"></span>${g.name}ï¼ˆ${g.grade}ï¼‰<span class="grade-subtotal">${gTotal > 0 ? 'å°è¨ˆ $' + gTotal.toLocaleString() : ''}</span></div>${shtml}</div>`;
  }).join('');
  const gradeNames = x.grades.map(g => g.grade.replace('å¹´ç´š','')).join('ï½');
  resultsDiv.innerHTML = `<div class="student-card"><div class="student-header"><span class="student-name">${x.name}</span><span class="student-seat">åº§è™Ÿ ${x.seat}</span></div><div class="total-banner"><span class="label">${gradeNames}å¹´ç´šç´¯è¨ˆç¸½è²»ç”¨</span><span class="amount">$${gt.toLocaleString()}</span></div>${gt > 0 ? `<div class="pay-btn-wrap"><button class="pay-btn" onclick="openPayModal('${x.name}', ${x.seat})">ğŸ’³ ç¹³è²»æ–¹å¼</button></div>` : ''}${html}</div>`;
}

function tog(el) { el.nextElementSibling.classList.toggle('open'); el.querySelector('.chevron').classList.toggle('open'); }

loadAllData();

// ============================================================
// â˜…â˜…â˜… ç¹³è²»å›å ±å½ˆçª— â˜…â˜…â˜…
// ============================================================

let currentStudent = { name: '', seat: 0 };

function openPayModal(name, seat) {
  currentStudent = { name, seat };
  // å»ºç«‹ modal HTML
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'payModal';
  overlay.onclick = function(e) { if (e.target === overlay) closePayModal(); };

  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ’³ é¸æ“‡ç¹³è²»æ–¹å¼</h2>
        <button class="modal-close" onclick="closePayModal()">âœ•</button>
      </div>
      <div class="modal-body">

        <!-- æ­¥é©Ÿä¸€ï¼šé¡¯ç¤ºç¹³è²»è³‡è¨Š -->
        <div class="modal-step active" id="stepInfo">
          <div class="pay-methods-row">
            <div class="pay-info-card">
              <div class="card-title">ğŸ¦ éŠ€è¡Œè½‰å¸³</div>
              <div class="pay-info-row"><span class="lbl">éŠ€è¡Œ</span><span class="val">${PAY_INFO.bank}</span></div>
              <div class="pay-info-row"><span class="lbl">åˆ†è¡Œ</span><span class="val">${PAY_INFO.branch}</span></div>
              <div class="pay-info-row"><span class="lbl">å¸³è™Ÿ</span><span class="val mono">${PAY_INFO.account}</span></div>
              <div class="pay-info-row"><span class="lbl">æˆ¶å</span><span class="val">${PAY_INFO.accountName}</span></div>
            </div>
            <div class="pay-info-card">
              <div class="card-title">ğŸ’š LINE PAY</div>
              <div style="font-size:.82rem;color:var(--text-soft);line-height:1.8">
                <a href="${PAY_INFO.linePayUrl}" target="_blank" style="color:var(--accent);font-weight:600;text-decoration:none">ğŸ‘‰ é»æ­¤åŠ å¥½å‹</a><br>
                æˆ¶åï¼š${PAY_INFO.accountName}<br>
                åŠ å¥½å‹å¾Œè«‹å‘ŠçŸ¥<br>æ˜¯å¹¾è™Ÿçš„å®¶é•·
              </div>
            </div>
          </div>
          <div class="pay-deadline">â° ç¹³è²»æˆªæ­¢æ—¥ï¼š${PAY_INFO.deadline}</div>
          <button class="btn-primary" onclick="goToStep('stepForm')">âœ… æˆ‘å·²ç¹³è²»ï¼Œå¡«å¯«å›å ±</button>
          <button class="btn-outline" onclick="closePayModal()">ç¨å¾Œå†ç¹³</button>
        </div>

        <!-- æ­¥é©ŸäºŒï¼šç¹³è²»å›å ±è¡¨å–® -->
        <div class="modal-step" id="stepForm">
          <div class="form-group">
            <label class="form-label">å­¸ç”Ÿå§“å</label>
            <input class="form-input readonly-info" type="text" value="${name}ï¼ˆåº§è™Ÿ ${seat}ï¼‰" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
            <select class="form-select" id="payMethod" onchange="onMethodChange()">
              <option value="">è«‹é¸æ“‡...</option>
              <option value="å¯Œé‚¦è½‰å¸³">å¯Œé‚¦éŠ€è¡Œè½‰å¸³</option>
              <option value="LinePay">LINE Pay</option>
            </select>
          </div>
          <div class="form-group" id="lastFiveGroup" style="display:none">
            <label class="form-label">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
            <input class="form-input" type="text" id="lastFive" placeholder="è«‹è¼¸å…¥å¾Œäº”ç¢¼" maxlength="5" inputmode="numeric">
            <div class="form-hint">æ–¹ä¾¿è€å¸«æ ¸å°æ¬¾é …</div>
          </div>
          <div id="linePayNote" style="display:none">
            <div class="linepay-note">
              ğŸ“± ä½¿ç”¨ LINE Pay ç¹³è²»è«‹æ³¨æ„ï¼š<br>
              1. <a href="${PAY_INFO.linePayUrl}" target="_blank" style="color:var(--koelr);font-weight:600">é»æ­¤åŠ ã€Œ${PAY_INFO.accountName}ã€ç‚ºå¥½å‹</a><br>
              2. è½‰å¸³æ™‚è«‹åœ¨è¨Šæ¯å‚™è¨»ã€Œ<strong>${seat}è™Ÿ ${name}</strong>ã€
            </div>
          </div>
          <button class="btn-primary" id="submitBtn" onclick="submitReport()" disabled>é€å‡ºç¹³è²»å›å ±</button>
          <button class="btn-outline" onclick="goToStep('stepInfo')">â† è¿”å›</button>
        </div>

        <!-- æ­¥é©Ÿä¸‰ï¼šæˆåŠŸç•«é¢ -->
        <div class="modal-step" id="stepSuccess">
          <div class="success-screen">
            <div class="success-icon">ğŸ‰</div>
            <h3>ç¹³è²»å›å ±å·²é€å‡ºï¼</h3>
            <p>è€å¸«æœƒå„˜å¿«ç¢ºèªæ‚¨çš„ç¹³è²»ç´€éŒ„<br>æ„Ÿè¬æ‚¨çš„é…åˆ âœ¨</p>
          </div>
          <button class="btn-primary" onclick="closePayModal()" style="margin-top:1rem">é—œé–‰</button>
        </div>

      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  document.body.style.overflow = 'hidden';
}

function closePayModal() {
  const modal = document.getElementById('payModal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

function goToStep(stepId) {
  document.querySelectorAll('#payModal .modal-step').forEach(s => s.classList.remove('active'));
  document.getElementById(stepId).classList.add('active');
}

function onMethodChange() {
  const method = document.getElementById('payMethod').value;
  const lastFiveGroup = document.getElementById('lastFiveGroup');
  const linePayNote = document.getElementById('linePayNote');
  const submitBtn = document.getElementById('submitBtn');

  if (method === 'å¯Œé‚¦è½‰å¸³') {
    lastFiveGroup.style.display = 'block';
    linePayNote.style.display = 'none';
    submitBtn.disabled = false;
  } else if (method === 'LinePay') {
    lastFiveGroup.style.display = 'none';
    linePayNote.style.display = 'block';
    submitBtn.disabled = false;
  } else {
    lastFiveGroup.style.display = 'none';
    linePayNote.style.display = 'none';
    submitBtn.disabled = true;
  }
}

async function submitReport() {
  const btn = document.getElementById('submitBtn');
  const method = document.getElementById('payMethod').value;
  const lastFive = method === 'å¯Œé‚¦è½‰å¸³' ? (document.getElementById('lastFive').value.trim()) : 'ï¼ˆLINE Payï¼‰';

  if (!method) return;

  // å¯Œé‚¦è½‰å¸³éœ€è¦å¾Œäº”ç¢¼
  if (method === 'å¯Œé‚¦è½‰å¸³' && !lastFive) {
    alert('è«‹å¡«å¯«åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼');
    return;
  }
  if (method === 'å¯Œé‚¦è½‰å¸³' && !/^\d{5}$/.test(lastFive)) {
    alert('å¾Œäº”ç¢¼è«‹å¡« 5 ä½æ•¸å­—');
    return;
  }

  // é˜²é‡è¤‡é€å‡º
  btn.disabled = true;
  btn.textContent = 'é€å‡ºä¸­...';

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        seat: currentStudent.seat,
        name: currentStudent.name,
        method: method,
        lastFive: lastFive,
      })
    });

    // no-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–å›æ‡‰ï¼Œç›´æ¥ç•¶ä½œæˆåŠŸ
    goToStep('stepSuccess');

  } catch (err) {
    alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤ï¼š' + err.message);
    btn.disabled = false;
    btn.textContent = 'é€å‡ºç¹³è²»å›å ±';
  }
}
</script>
</body>
</html>
