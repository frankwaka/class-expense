<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#F5F2EC;--card:#FFF;--accent:#5B7F6E;--accent-light:#E4EDE8;--accent-dark:#3D5A4C;--text:#2C2C2C;--text-soft:#7A7A7A;--border:#E4DFD7;--paid:#4A8B6F;--unpaid:#C4553A;--highlight:#FFF9ED;--shadow:0 2px 16px rgba(0,0,0,0.05);--radius:16px;--cherry:#D4736E;--cherry-bg:#FDF0EF;--koelr:#6B8F5B;--koelr-bg:#F0F5ED;--cotton:#C2855A;--cotton-bg:#FDF5EE;--maple:#B5564E;--maple-bg:#FBF0EF}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:linear-gradient(135deg,#3D5A4C,#5B7F6E,#7FA08E);color:#fff;padding:2.2rem 1.5rem 2rem;text-align:center;position:relative;overflow:hidden}
.header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--cherry),#E8A87C,var(--koelr),#7FB5B0)}
.header h1{font-size:1.5rem;font-weight:700;letter-spacing:3px;margin-bottom:.3rem}
.header p{font-size:.82rem;opacity:.7;font-weight:300}
.container{max-width:640px;margin:0 auto;padding:1.5rem 1rem 3rem}
.search-section{background:var(--card);border-radius:var(--radius);padding:1.4rem;box-shadow:var(--shadow);margin-bottom:1.5rem}
.search-label{font-size:.78rem;font-weight:500;color:var(--text-soft);margin-bottom:.5rem;letter-spacing:1px}
.search-row{display:flex;gap:.6rem}
.search-wrapper{position:relative;flex:1}
.search-wrapper input{width:100%;padding:.8rem 1rem;border:1.5px solid var(--border);border-radius:12px;font-size:1rem;font-family:inherit;background:var(--bg);outline:none;transition:all .2s}
.search-wrapper input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
.btn-search{padding:.8rem 1.4rem;background:var(--accent);color:#fff;border:none;border-radius:12px;font-size:.95rem;font-family:inherit;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-search:hover{background:var(--accent-dark)}
.btn-search:active{transform:scale(.97)}
.autocomplete-list{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card);border:1.5px solid var(--border);border-radius:12px;max-height:220px;overflow-y:auto;z-index:100;display:none;box-shadow:0 8px 28px rgba(0,0,0,.1)}
.autocomplete-list.show{display:block}
.ac-item{padding:.65rem 1rem;cursor:pointer;font-size:.9rem;display:flex;justify-content:space-between;transition:background .1s}
.ac-item:first-child{border-radius:11px 11px 0 0}.ac-item:last-child{border-radius:0 0 11px 11px}
.ac-item:hover{background:var(--accent-light)}.ac-item .seat{color:var(--text-soft);font-size:.8rem}
.hint{text-align:center;padding:3.5rem 1rem;color:var(--text-soft)}
.hint-icon{font-size:3rem;margin-bottom:.8rem;opacity:.35}.hint p{font-size:.88rem;line-height:1.7}
.student-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;animation:slideUp .35s ease-out;margin-bottom:1.2rem}
@keyframes slideUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.student-header{padding:1.2rem 1.4rem;background:linear-gradient(135deg,var(--accent-dark),var(--accent));color:#fff;display:flex;justify-content:space-between;align-items:center}
.student-name{font-size:1.35rem;font-weight:700}
.student-seat{font-size:.78rem;background:rgba(255,255,255,.18);padding:.25rem .75rem;border-radius:20px}
.total-banner{background:var(--highlight);padding:1rem 1.4rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.total-banner .label{font-size:.85rem;color:var(--text-soft);font-weight:500}
.total-banner .amount{font-family:'Outfit',sans-serif;font-size:1.5rem;font-weight:700;color:var(--accent-dark)}
.grade-header{padding:.75rem 1.4rem;font-size:.82rem;font-weight:700;letter-spacing:2px;display:flex;align-items:center;gap:.5rem;border-bottom:1px solid var(--border)}
.grade-header.cherry{background:var(--cherry-bg);color:var(--cherry)}
.grade-header.koelr{background:var(--koelr-bg);color:var(--koelr)}
.grade-header.cotton{background:var(--cotton-bg);color:var(--cotton)}
.grade-header.maple{background:var(--maple-bg);color:var(--maple)}
.grade-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.grade-dot.cherry{background:var(--cherry)}.grade-dot.koelr{background:var(--koelr)}.grade-dot.cotton{background:var(--cotton)}.grade-dot.maple{background:var(--maple)}
.grade-subtotal{margin-left:auto;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600}
.season-group{border-bottom:1px solid #F0ECE5}.season-group:last-child{border-bottom:none}
.season-header{padding:.8rem 1.4rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .12s;user-select:none}
.season-header:hover{background:#FAFAF6}
.season-title{font-weight:600;font-size:.92rem;display:flex;align-items:center;gap:.45rem}
.season-icon{font-size:1rem}
.season-right{display:flex;align-items:center;gap:.5rem}
.season-total{font-family:'Outfit',sans-serif;font-weight:600;font-size:.95rem;color:var(--accent)}
.season-paid{display:inline-flex;align-items:center;font-size:.7rem;font-weight:600;padding:.15rem .5rem;border-radius:10px}
.paid-yes{background:var(--accent-light);color:var(--paid)}.paid-no{background:#FDE8E4;color:var(--unpaid)}
.chevron{font-size:.65rem;transition:transform .2s;color:#bbb;margin-left:.2rem}.chevron.open{transform:rotate(180deg)}
.season-details{padding:0 1.4rem .8rem;display:none;padding-left:2.8rem}.season-details.open{display:block}
.course-row{display:flex;justify-content:space-between;align-items:center;padding:.45rem 0;border-bottom:1px dashed #EDE9E3;font-size:.85rem}
.course-row:last-child{border-bottom:none}
.course-name{color:var(--text-soft)}
.course-amount{font-family:'Outfit',sans-serif;font-weight:600;min-width:55px;text-align:right}
.no-course{color:#c5c0b8;font-size:.82rem;padding:.35rem 0}
.error-msg{text-align:center;padding:2.5rem 1rem;color:var(--unpaid);animation:slideUp .3s ease-out}
.error-msg .icon{font-size:2.5rem;margin-bottom:.5rem}.error-msg p{font-size:.88rem}
.footer{text-align:center;padding:1.5rem;color:var(--text-soft);font-size:.72rem;opacity:.5}
.loading{text-align:center;padding:3rem 1rem;color:var(--text-soft)}
.loading-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 1rem}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{font-size:.88rem}
.status-bar{background:var(--card);border-radius:10px;padding:.6rem 1rem;margin-bottom:1rem;font-size:.75rem;color:var(--text-soft);display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
.status-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:.4rem}
.status-dot.ok{background:#4A8B6F}.status-dot.err{background:var(--unpaid)}
@media(max-width:480px){.search-row{flex-wrap:wrap}.search-wrapper,.btn-search{flex:1 1 100%}.header h1{font-size:1.3rem}.container{padding:1rem .7rem 2rem}.season-details{padding-left:2rem}}
</style>
</head>
<body>
<div class="header"><h1>ğŸ“š é¸ä¿®è²»ç”¨æŸ¥è©¢</h1><p>è¼¸å…¥å°æœ‹å‹çš„å§“åæˆ–åº§è™ŸæŸ¥çœ‹è²»ç”¨æ˜ç´°</p></div>
<div class="container">
<div class="search-section"><div class="search-label">æœå°‹å­¸ç”Ÿ</div><div class="search-row"><div class="search-wrapper"><input type="text" id="searchInput" placeholder="å§“åæˆ–åº§è™Ÿ..." autocomplete="off" disabled><div class="autocomplete-list" id="autocomplete"></div></div><button class="btn-search" onclick="doSearch()" disabled id="searchBtn">æŸ¥ è©¢</button></div></div>
<div id="results"><div class="loading"><div class="loading-spinner"></div><p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p></div></div>
</div>
<div class="footer">ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±</div>

<script>
// ============================================================
// â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
// ============================================================
const SHEET_ID = '1TeY09vzx3eAJilaOdqytpoElxy13r_VQ';
const SHEET_NAME = 'é¸ä¿®è²»';

// å¹´ç´šè¨­å®šï¼šç”¨æ¬„ä½å‰ç¶´ä¾†å€åˆ†å“ªäº›æ¬„å±¬æ–¼å“ªå€‹å¹´ç´š
// prefix: è©¦ç®—è¡¨æ¬„ä½é–‹é ­æ˜¯é€™äº›å­—çš„ï¼Œå°±æ­¸åˆ°é€™å€‹å¹´ç´š
const GRADE_CONFIG = [
  { name:"å±±æ«»ç­", grade:"ä¸‰å¹´ç´š", colorClass:"cherry",
    prefixes:["ç§‹","å†¬","æ˜¥","å±±å¤","å±±æ«»"] },
  { name:"æ¬’æ¨¹ç­", grade:"å››å¹´ç´š", colorClass:"koelr",
    prefixes:["æ¬’ç§‹","æ¬’å†¬","æ¬’æ¨¹","æ¬’æ˜¥","æ¬’å¤"] },
  // æœªä¾†æ–°å¢ï¼ˆæŠŠè¨»è§£æ‹¿æ‰å°±å¥½ï¼‰ï¼š
  // { name:"æœ¨æ£‰ç­", grade:"äº”å¹´ç´š", colorClass:"cotton",
  //   prefixes:["æœ¨ç§‹","æœ¨å†¬","æœ¨æ˜¥","æœ¨å¤","æœ¨æ£‰"] },
  // { name:"æ¥“é¦™ç­", grade:"å…­å¹´ç´š", colorClass:"maple",
  //   prefixes:["æ¥“ç§‹","æ¥“å†¬","æ¥“æ˜¥","æ¥“å¤","æ¥“é¦™"] },
];
// ============================================================

const SEASON_MAP = {"ç§‹":"ğŸ‚","å†¬":"â„ï¸","æ˜¥":"ğŸŒ¸","å¤":"â˜€ï¸"};
function getSeasonIcon(name) {
  for (const [k,v] of Object.entries(SEASON_MAP)) { if (name.includes(k)) return v; }
  return "ğŸ“˜";
}

// åˆ¤æ–·ä¸€å€‹æ¬„ä½å±¬æ–¼å“ªå€‹å¹´ç´š
function matchGrade(colName) {
  // ä¾ prefix é•·åº¦ç”±é•·åˆ°çŸ­æ¯”å°ï¼Œé¿å…ã€Œç§‹ã€èª¤é…ã€Œæ¬’ç§‹ã€
  for (const g of [...GRADE_CONFIG].sort((a,b) => {
    const maxA = Math.max(...a.prefixes.map(p=>p.length));
    const maxB = Math.max(...b.prefixes.map(p=>p.length));
    return maxB - maxA;
  })) {
    for (const p of g.prefixes.sort((a,b)=>b.length-a.length)) {
      if (colName.startsWith(p)) return g;
    }
  }
  return null;
}

// å¾æ¬„ä½ååˆ¤æ–·å­£ç¯€å
function getSeasonName(colName, gradeConfig) {
  // "æ¬’ç§‹-æ‰‹ä½œ" â†’ æ‰¾åˆ° prefix "æ¬’ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "æ˜¥-ç¥è¾²æ°" â†’ å­£ç¯€æ˜¯ "æ˜¥å­¸å­£"
  for (const p of gradeConfig.prefixes.sort((a,b)=>b.length-a.length)) {
    if (colName.startsWith(p)) {
      // å–å‡ºå­£ç¯€å­—ï¼šæœ€å¾Œä¸€å€‹å­—
      const lastChar = p.slice(-1);
      for (const s of Object.keys(SEASON_MAP)) {
        if (lastChar === s || p.includes(s)) return s + "å­¸å­£";
      }
      return p + "å­¸å­£";
    }
  }
  return "å…¶ä»–";
}

// å–å¾—èª²ç¨‹é¡¯ç¤ºåç¨±
function getCourseName(colName) {
  const dash = colName.indexOf('-');
  if (dash >= 0) return colName.substring(dash + 1);
  return colName + "é¸ä¿®";
}

let allStudents = [];
let dataReady = false;

async function fetchSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
  if (!jsonStr) throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨è³‡æ–™ï¼Œè«‹ç¢ºèªåˆ†äº«è¨­å®š');
  return JSON.parse(jsonStr[1]);
}

function parseData(json) {
  const cols = json.table.cols.map(c => (c.label || '').trim());
  const rows = json.table.rows;

  const seatIdx = cols.findIndex(c => c.includes('åº§è™Ÿ'));
  const nameIdx = cols.findIndex(c => c.includes('å§“å'));
  if (seatIdx === -1 || nameIdx === -1) throw new Error('æ‰¾ä¸åˆ°ã€Œåº§è™Ÿã€æˆ–ã€Œå§“åã€æ¬„ä½');

  // åˆ†ææ¯å€‹æ¬„ä½æ­¸å±¬
  // colInfo[i] = { grade, seasonName, courseName, isPaid, colIdx }
  const colInfos = [];
  let lastDataCol = null; // è¿½è¹¤ã€Œå·²ç¹³æ¬¾ã€å°æ‡‰çš„å‰ä¸€å€‹è³‡æ–™æ¬„

  for (let i = 0; i < cols.length; i++) {
    const col = cols[i];
    if (i === seatIdx || i === nameIdx || !col) continue;

    if (col === 'å·²ç¹³æ¬¾') {
      // æ¨™è¨˜å‰ä¸€å€‹å­¸å­£çš„ paid æ¬„ä½
      if (lastDataCol) lastDataCol.paidIdx = i;
      continue;
    }
    if (col.includes('ç¸½é¡') || col.includes('é¸ä¿®è²»')) {
      continue; // è·³éå°è¨ˆæ¬„
    }

    const grade = matchGrade(col);
    if (!grade) continue;

    const seasonName = getSeasonName(col, grade);
    const courseName = getCourseName(col);

    const info = { grade: grade, seasonName, courseName, colIdx: i, paidIdx: -1 };
    colInfos.push(info);
    lastDataCol = info;
  }

  // çµ„ç¹”æˆ grade â†’ season â†’ courses çµæ§‹
  const students = [];

  for (const row of rows) {
    const cells = row.c || [];
    const seatVal = cells[seatIdx]?.v;
    const nameVal = cells[nameIdx]?.v;
    if (!seatVal || !nameVal) continue;
    if (typeof seatVal === 'string' && seatVal.includes('å…¥ç­è²»')) continue;
    const seat = Math.round(Number(seatVal));
    if (isNaN(seat)) continue;

    // å»ºç«‹æ¯å€‹å¹´ç´šçš„è³‡æ–™
    const grades = [];
    for (const gc of GRADE_CONFIG) {
      const myCols = colInfos.filter(c => c.grade === gc);
      if (myCols.length === 0) continue;

      // åˆ†çµ„æˆå­¸å­£
      const seasonMap = {};
      for (const ci of myCols) {
        if (!seasonMap[ci.seasonName]) {
          seasonMap[ci.seasonName] = { name: ci.seasonName, icon: getSeasonIcon(ci.seasonName), courses: [], paidIdx: -1 };
        }
        const amount = Number(cells[ci.colIdx]?.v) || 0;
        seasonMap[ci.seasonName].courses.push({ label: ci.courseName, amount });
        if (ci.paidIdx >= 0) seasonMap[ci.seasonName].paidIdx = ci.paidIdx;
      }

      const seasons = Object.values(seasonMap).map(sn => {
        const total = sn.courses.reduce((a, c) => a + c.amount, 0);
        const paid = sn.paidIdx >= 0 ? (cells[sn.paidIdx]?.v === 'v' ? 'v' : '') : null;
        return { ...sn, total, paid };
      });

      grades.push({ name: gc.name, grade: gc.grade, colorClass: gc.colorClass, seasons });
    }

    students.push({ seat, name: nameVal, grades });
  }

  return students;
}

async function loadAllData() {
  const resultsDiv = document.getElementById('results');
  try {
    const json = await fetchSheet();
    allStudents = parseData(json);
    dataReady = true;

    document.getElementById('searchInput').disabled = false;
    document.getElementById('searchBtn').disabled = false;

    const now = new Date();
    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

    resultsDiv.innerHTML = `
      <div class="status-bar"><span><span class="status-dot ok"></span>è³‡æ–™å·²è¼‰å…¥ï¼ˆ${allStudents.length} ä½å­¸ç”Ÿï¼‰</span><span>æ›´æ–°ï¼š${timeStr}</span></div>
      <div class="hint"><div class="hint-icon">ğŸ”</div><p>è¼¸å…¥å°æœ‹å‹çš„å§“åæˆ–åº§è™Ÿ<br>å³å¯æŸ¥çœ‹å„å­¸å­£çš„é¸ä¿®è²»ç”¨æ˜ç´°</p></div>`;
  } catch (err) {
    resultsDiv.innerHTML = `
      <div class="error-msg"><div class="icon">âš ï¸</div>
        <p>è¼‰å…¥è³‡æ–™å¤±æ•—</p>
        <p style="margin-top:.8rem;font-size:.82rem;line-height:1.6">è«‹ç¢ºèªï¼š<br>1. è©¦ç®—è¡¨å·²è¨­å®šã€ŒçŸ¥é“é€£çµçš„äººå¯ä»¥æª¢è¦–ã€<br>2. é ç±¤åç¨±ç‚ºã€Œ${SHEET_NAME}ã€</p>
        <p style="margin-top:.8rem;font-size:.75rem;color:#bbb">${err.message}</p>
      </div>`;
  }
}

// === æœå°‹ ===
const searchInput = document.getElementById('searchInput');
const acList = document.getElementById('autocomplete');
const resultsDiv = document.getElementById('results');

searchInput.addEventListener('input', () => {
  if (!dataReady) return;
  const q = searchInput.value.trim();
  if (!q) { acList.classList.remove('show'); return; }
  const m = allStudents.filter(x => x.name.includes(q) || String(x.seat) === q || String(x.seat).startsWith(q)).slice(0, 8);
  if (!m.length) { acList.classList.remove('show'); return; }
  acList.innerHTML = m.map(x => `<div class="ac-item" data-seat="${x.seat}" data-name="${x.name}"><span>${x.name}</span><span class="seat">åº§è™Ÿ ${x.seat}</span></div>`).join('');
  acList.classList.add('show');
});

acList.addEventListener('click', e => {
  const item = e.target.closest('.ac-item');
  if (!item) return;
  searchInput.value = item.dataset.name;
  acList.classList.remove('show');
  const x = allStudents.find(s => s.seat === Number(item.dataset.seat) && s.name === item.dataset.name);
  if (x) render(x);
});

searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
document.addEventListener('click', e => { if (!e.target.closest('.search-wrapper')) acList.classList.remove('show'); });

function doSearch() {
  if (!dataReady) return;
  acList.classList.remove('show');
  const q = searchInput.value.trim();
  if (!q) return;
  const x = allStudents.find(s => s.name === q || String(s.seat) === q) || allStudents.find(s => s.name.includes(q));
  if (x) render(x);
  else resultsDiv.innerHTML = `<div class="error-msg"><div class="icon">ğŸ˜•</div><p>æ‰¾ä¸åˆ°ã€Œ${q}ã€ï¼Œè«‹ç¢ºèªå§“åæˆ–åº§è™Ÿ</p></div>`;
}

function render(x) {
  let gt = 0;
  const html = x.grades.map(g => {
    let gTotal = 0;
    const shtml = g.seasons.map(sn => {
      const active = sn.courses.filter(c => c.amount > 0);
      gTotal += sn.total; gt += sn.total;
      return `<div class="season-group"><div class="season-header" onclick="tog(this)"><div class="season-title"><span class="season-icon">${sn.icon}</span>${sn.name}${sn.paid !== null && sn.total > 0 ? (sn.paid === 'v' ? '<span class="season-paid paid-yes">âœ“ å·²ç¹³</span>' : '<span class="season-paid paid-no">æœªç¹³</span>') : ''}</div><div class="season-right"><span class="season-total">${sn.total > 0 ? '$' + sn.total.toLocaleString() : '-'}</span><span class="chevron">â–¼</span></div></div><div class="season-details">${active.length > 0 ? active.map(c => `<div class="course-row"><span class="course-name">${c.label}</span><span class="course-amount">$${c.amount.toLocaleString()}</span></div>`).join('') : '<div class="no-course">æœ¬å­¸å­£ç„¡é¸ä¿®è²»ç”¨</div>'}</div></div>`;
    }).join('');
    return `<div class="grade-section"><div class="grade-header ${g.colorClass}"><span class="grade-dot ${g.colorClass}"></span>${g.name}ï¼ˆ${g.grade}ï¼‰<span class="grade-subtotal">${gTotal > 0 ? 'å°è¨ˆ $' + gTotal.toLocaleString() : ''}</span></div>${shtml}</div>`;
  }).join('');
  const gradeNames = x.grades.map(g => g.grade.replace('å¹´ç´š','')).join('ï½');
  resultsDiv.innerHTML = `<div class="student-card"><div class="student-header"><span class="student-name">${x.name}</span><span class="student-seat">åº§è™Ÿ ${x.seat}</span></div><div class="total-banner"><span class="label">${gradeNames}å¹´ç´šç´¯è¨ˆç¸½è²»ç”¨</span><span class="amount">$${gt.toLocaleString()}</span></div>${html}</div>`;
}

function tog(el) { el.nextElementSibling.classList.toggle('open'); el.querySelector('.chevron').classList.toggle('open'); }

loadAllData();
</script>
</body>
</html>
