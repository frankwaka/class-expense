<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Claude Brand Color Theme + V0 Layout â”€â”€ */
:root {
  --bg: #FAF6F3;
  --bg-warm: #F3EEEA;
  --card: #FFFFFF;
  --card-hover: #FDF9F7;
  --accent: #D97757;
  --accent-light: #F8E4DC;
  --accent-dark: #C0654A;
  --accent-soft: #E8A88E;
  --text: #3D3530;
  --text-soft: #6E615A;
  --text-muted: #A89A92;
  --border: #E8DED6;
  --border-light: #F0E8E2;
  --paid: #6A9B6A;
  --paid-bg: #EDF5ED;
  --unpaid: #C4645A;
  --unpaid-bg: #FAEDEB;
  --highlight: #FFF8F4;
  --shadow-sm: 0 2px 6px rgba(217,119,87,.06);
  --shadow: 0 3px 12px rgba(217,119,87,.08);
  --shadow-md: 0 6px 20px rgba(217,119,87,.1);
  --shadow-lg: 0 10px 36px rgba(217,119,87,.12);
  --radius: 24px;
  --radius-sm: 18px;
  --radius-xs: 14px;
  --cherry: #D97757;
  --cherry-bg: #F8EDE8;
  --koelr: #7A9A5E;
  --koelr-bg: #EFF4EA;
  --cotton: #C08A56;
  --cotton-bg: #F7EEE3;
  --maple: #B05E52;
  --maple-bg: #F5E9E6;
  --transition: .25s cubic-bezier(.4,0,.2,1);
  --font-num: 'DM Sans', sans-serif;
}

/* â”€â”€ Reset â”€â”€ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

/* â”€â”€ Body â”€â”€ */
body {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.7;
}

/* â”€â”€ Header â”€â”€ */
.header {
  background: linear-gradient(135deg, #D97757 0%, #E0926E 100%);
  padding: 2rem 1.5rem 2.5rem;
  text-align: center;
  position: relative;
  overflow: hidden;
  border-radius: 0 0 40px 40px;
  box-shadow: 0 8px 32px rgba(217,119,87,.25);
}
.header::before {
  display: none;
}
.header::after {
  content: 'ğŸŒ¸ ğŸŒ¼ ğŸŒ·';
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  letter-spacing: 8px;
  opacity: .5;
}
.header-inner {
  position: relative;
}
.header-badge {
  display: inline-flex;
  align-items: center;
  font-size: .75rem;
  font-weight: 600;
  letter-spacing: 3px;
  color: rgba(255,255,255,.85);
  margin-bottom: 1rem;
  text-transform: uppercase;
  background: rgba(255,255,255,.2);
  padding: .4rem 1rem;
  border-radius: 20px;
}
.header h1 {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 2.2rem;
  font-weight: 700;
  letter-spacing: 6px;
  color: #fff;
  margin-bottom: .6rem;
  text-shadow: 0 2px 8px rgba(0,0,0,.1);
}
.header p {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 1.05rem;
  color: rgba(255,255,255,.9);
  font-weight: 500;
  letter-spacing: 2px;
}

/* â”€â”€ Container â”€â”€ */
.container {
  max-width: 520px;
  margin: 0 auto;
  padding: 1.5rem 1rem 3rem;
}

/* â”€â”€ Search Section â”€â”€ */
.search-section {
  background: var(--card);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow-md);
  margin-bottom: 1.5rem;
  margin-top: -1.5rem;
  border: 2px solid var(--border-light);
  position: relative;
}
.search-section::before {
  display: none;
}
.search-label {
  font-size: .8rem;
  font-weight: 600;
  color: var(--text-soft);
  margin-bottom: .8rem;
  letter-spacing: 2px;
  text-align: center;
}
.search-row {
  display: flex;
  gap: .8rem;
}
.search-wrapper {
  position: relative;
  flex: 1;
}
.search-wrapper input {
  width: 100%;
  padding: 1rem 1.2rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: 1.1rem;
  font-family: inherit;
  background: var(--bg-warm);
  color: var(--text);
  outline: none;
  transition: all var(--transition);
}
.search-wrapper input::placeholder {
  color: var(--text-muted);
  font-weight: 400;
}
.search-wrapper input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(217,119,87,.15);
  background: var(--card);
}
.search-wrapper input:disabled {
  opacity: .5;
  cursor: not-allowed;
}
.btn-search {
  padding: 1rem 1.8rem;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: .95rem;
  font-family: inherit;
  font-weight: 700;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  letter-spacing: 2px;
  box-shadow: 0 4px 12px rgba(217,119,87,.3);
}
.btn-search:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--accent-dark) 0%, #A85540 100%);
  box-shadow: 0 6px 20px rgba(217,119,87,.4);
  transform: translateY(-2px);
}
.btn-search:active:not(:disabled) { transform: scale(.97) translateY(0); }
.btn-search:disabled { opacity: .4; cursor: not-allowed; }

/* â”€â”€ Autocomplete â”€â”€ */
.autocomplete-list {
  position: absolute;
  top: calc(100% + 10px);
  left: 0;
  right: 0;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  max-height: 260px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: var(--shadow-lg);
}
.autocomplete-list.show { display: block; animation: dropDown .2s ease; }
@keyframes dropDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.ac-item {
  padding: .85rem 1.2rem;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all var(--transition);
  border-bottom: 1px solid var(--border-light);
}
.ac-item:last-child { border-bottom: none; }
.ac-item:first-child { border-radius: 16px 16px 0 0; }
.ac-item:last-child { border-radius: 0 0 16px 16px; }
.ac-item:only-child { border-radius: 16px; }
.ac-item:hover { background: var(--accent-light); padding-left: 1.5rem; }
.ac-item .seat {
  color: var(--text-muted);
  font-size: .82rem;
  font-weight: 600;
  background: var(--bg-warm);
  padding: .25rem .6rem;
  border-radius: 10px;
}

/* â”€â”€ Scrollbar â”€â”€ */
.autocomplete-list::-webkit-scrollbar { width: 3px; }
.autocomplete-list::-webkit-scrollbar-track { background: transparent; }
.autocomplete-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ Hint â”€â”€ */
.hint {
  text-align: center;
  padding: 3rem 1.5rem;
  color: var(--text-soft);
  background: var(--card);
  border-radius: var(--radius);
  border: 2px dashed var(--border);
}
.hint-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: .8;
}
.hint p {
  font-size: 1rem;
  line-height: 2;
  color: var(--text-soft);
  font-weight: 500;
}

/* â”€â”€ Student Card â”€â”€ */
.student-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  animation: slideUp .4s cubic-bezier(.4,0,.2,1);
  margin-bottom: 1.2rem;
  border: 2px solid var(--border-light);
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px) scale(.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.student-header {
  padding: 1.4rem 1.6rem;
  background: linear-gradient(135deg, #D97757 0%, #E8A88E 100%);
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}
.student-header::before {
  display: none;
}
.student-header::after {
  content: 'â­';
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: .9rem;
  opacity: .4;
}
.student-name {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 1.7rem;
  font-weight: 700;
  letter-spacing: 4px;
  text-shadow: 0 2px 4px rgba(0,0,0,.1);
  position: relative;
}
.student-seat {
  font-size: .8rem;
  font-weight: 600;
  background: rgba(255,255,255,.25);
  padding: .35rem .9rem;
  border-radius: 20px;
  letter-spacing: 1px;
  backdrop-filter: blur(4px);
  position: relative;
}

/* â”€â”€ Total Banner â”€â”€ */
.total-banner {
  background: var(--accent-light);
  padding: 1.2rem 1.6rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--border-light);
}
.total-banner .label {
  font-size: .9rem;
  color: var(--text-soft);
  font-weight: 500;
  letter-spacing: .5px;
}
.total-banner .amount {
  font-family: var(--font-num);
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent-dark);
  letter-spacing: -.5px;
  text-shadow: 0 1px 2px rgba(0,0,0,.05);
}
.pay-btn-wrap {
  padding: 1rem 1.6rem;
  border-bottom: 2px solid var(--border-light);
  text-align: center;
  background: var(--bg-warm);
}
.pay-btn {
  display: inline-flex;
  align-items: center;
  gap: .6rem;
  padding: .9rem 2.2rem;
  background: linear-gradient(135deg, #6A9B6A 0%, #578B57 100%);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: 1rem;
  font-family: inherit;
  font-weight: 700;
  cursor: pointer;
  text-decoration: none;
  letter-spacing: 2px;
  transition: all var(--transition);
  box-shadow: 0 4px 16px rgba(106,155,106,.35);
}
.pay-btn:hover {
  background: linear-gradient(135deg, #578B57 0%, #487B48 100%);
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(106,155,106,.45);
}
.pay-btn:active { transform: translateY(0); }

/* â”€â”€ Grade Headers â”€â”€ */
.grade-section {}
.grade-header {
  padding: .9rem 1.6rem;
  font-size: .85rem;
  font-weight: 700;
  letter-spacing: 2px;
  display: flex;
  align-items: center;
  gap: .6rem;
  border-bottom: 2px solid var(--border-light);
}
.grade-header.cherry { background: var(--cherry-bg); color: var(--cherry); }
.grade-header.koelr  { background: var(--koelr-bg);  color: var(--koelr); }
.grade-header.cotton { background: var(--cotton-bg); color: var(--cotton); }
.grade-header.maple  { background: var(--maple-bg);  color: var(--maple); }
.grade-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
  box-shadow: 0 2px 6px currentColor;
  opacity: .8;
}
.grade-dot.cherry { background: var(--cherry); }
.grade-dot.koelr  { background: var(--koelr); }
.grade-dot.cotton { background: var(--cotton); }
.grade-dot.maple  { background: var(--maple); }
.grade-subtotal {
  margin-left: auto;
  font-family: var(--font-num);
  font-size: .95rem;
  font-weight: 700;
}

/* â”€â”€ Season Groups â”€â”€ */
.season-group {
  border-bottom: 1px solid var(--border-light);
}
.season-group:last-child { border-bottom: none; }
.season-header {
  padding: 1rem 1.6rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all var(--transition);
  user-select: none;
}
.season-header:hover { background: var(--card-hover); padding-left: 1.8rem; }
.season-title {
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: .55rem;
  color: var(--text);
}
.season-icon { font-size: 1.2rem; }
.season-right {
  display: flex;
  align-items: center;
  gap: .6rem;
}
.season-total {
  font-family: var(--font-num);
  font-weight: 700;
  font-size: 1rem;
  color: var(--accent-dark);
}
.season-paid {
  display: inline-flex;
  align-items: center;
  font-size: .72rem;
  font-weight: 700;
  padding: .3rem .7rem;
  border-radius: 20px;
  letter-spacing: .5px;
}
.paid-yes {
  background: var(--paid-bg);
  color: var(--paid);
  box-shadow: 0 2px 8px rgba(106,155,106,.2);
}
.paid-no {
  background: var(--unpaid-bg);
  color: var(--unpaid);
  box-shadow: 0 2px 8px rgba(196,100,90,.2);
}
.chevron {
  font-size: .55rem;
  transition: transform .25s cubic-bezier(.4,0,.2,1);
  color: var(--text-muted);
  margin-left: .2rem;
}
.chevron.open { transform: rotate(180deg); }

/* â”€â”€ Season Details â”€â”€ */
.season-details {
  padding: .5rem 1.6rem 1rem;
  display: none;
  padding-left: 3rem;
  background: var(--bg-warm);
  margin: 0 .5rem .5rem;
  border-radius: var(--radius-xs);
}
.season-details.open { display: block; animation: expandIn .25s ease; }
@keyframes expandIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.course-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: .65rem 0;
  border-bottom: 1px dashed var(--border);
  font-size: 1.05rem;
}
.course-row:last-child { border-bottom: none; }
.course-name {
  color: var(--text-soft);
  font-weight: 500;
}
.course-amount {
  font-family: var(--font-num);
  font-weight: 700;
  min-width: 60px;
  text-align: right;
  color: var(--accent-dark);
}
.no-course {
  color: var(--text-muted);
  font-size: .95rem;
  padding: .5rem 0;
  font-weight: 400;
  font-style: italic;
}

/* â”€â”€ Error â”€â”€ */
.error-msg {
  text-align: center;
  padding: 3rem 1.5rem;
  color: var(--unpaid);
  animation: slideUp .35s cubic-bezier(.4,0,.2,1);
  background: var(--card);
  border-radius: var(--radius);
  border: 2px solid var(--unpaid-bg);
}
.error-msg .icon { font-size: 3rem; margin-bottom: 1rem; }
.error-msg p { font-size: 1rem; font-weight: 500; }

/* â”€â”€ Footer â”€â”€ */
.footer {
  text-align: center;
  padding: 2.5rem 1rem 1.5rem;
  color: var(--text-muted);
  font-size: .8rem;
  letter-spacing: 2px;
  font-weight: 500;
}

/* â”€â”€ Loading â”€â”€ */
.loading {
  text-align: center;
  padding: 4rem 1.5rem;
  color: var(--text-soft);
  background: var(--card);
  border-radius: var(--radius);
  border: 2px dashed var(--border);
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto 1.2rem;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading p { font-size: 1rem; color: var(--text-soft); font-weight: 500; }

/* â”€â”€ Status Bar â”€â”€ */
.status-bar {
  background: var(--card);
  border-radius: var(--radius-xs);
  padding: .8rem 1.2rem;
  margin-bottom: 1.2rem;
  font-size: .85rem;
  color: var(--text-soft);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
  border: 2px solid var(--border-light);
  font-weight: 500;
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: .5rem;
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
.status-dot.ok  { background: var(--paid); box-shadow: 0 0 8px var(--paid); }
.status-dot.err { background: var(--unpaid); box-shadow: 0 0 8px var(--unpaid); }

/* â”€â”€ Mobile First - Larger, easier to read text â”€â”€ */
@media (max-width: 480px) {
  .header { padding: 1.8rem 1.2rem 2.2rem; border-radius: 0 0 30px 30px; }
  .header h1 { font-size: 2rem; letter-spacing: 3px; }
  .header p { font-size: 1.15rem; }
  .header::after { font-size: 1rem; bottom: 10px; }
  .container { padding: 1.2rem .85rem 2.5rem; }
  .search-section { padding: 1.3rem; margin-top: -1rem; }
  .search-section::before { font-size: 1.5rem; top: -18px; }
  .search-label { font-size: .9rem; }
  .search-row { flex-direction: column; gap: .7rem; }
  .search-wrapper { width: 100%; }
  .search-wrapper input { font-size: 1.2rem; padding: 1.1rem 1.2rem; }
  .btn-search { width: 100%; padding: 1.1rem; font-size: 1.1rem; }
  .student-name { font-size: 1.9rem; letter-spacing: 3px; }
  .student-seat { font-size: .9rem; padding: .4rem 1rem; }
  .total-banner .label { font-size: 1rem; }
  .total-banner .amount { font-size: 2rem; }
  .pay-btn { font-size: 1.1rem; padding: 1rem 2.2rem; }
  .grade-header { padding: 1rem 1.3rem; font-size: .95rem; }
  .grade-subtotal { font-size: 1.05rem; }
  .grade-dot { width: 12px; height: 12px; }
  .season-header { padding: 1rem 1.3rem; }
  .season-header:hover { padding-left: 1.5rem; }
  .season-title { font-size: 1.15rem; }
  .season-icon { font-size: 1.3rem; }
  .season-total { font-size: 1.1rem; }
  .season-paid { font-size: .82rem; padding: .35rem .8rem; }
  .season-details { padding: .7rem 1rem 1rem 2.5rem; margin: 0 .3rem .5rem; }
  .course-row { font-size: 1.1rem; padding: .75rem 0; }
  .course-amount { font-size: 1.1rem; }
  .no-course { font-size: 1rem; }
  .student-header { padding: 1.2rem 1.3rem; }
  .student-header::after { font-size: .8rem; }
  .total-banner { padding: 1rem 1.3rem; }
  .hint { padding: 2.5rem 1.2rem; }
  .hint-icon { font-size: 3.5rem; }
  .hint p { font-size: 1.1rem; line-height: 2.2; }
  .status-bar { font-size: .9rem; padding: .9rem 1rem; }
  .status-dot { width: 10px; height: 10px; }
  .ac-item { font-size: 1.1rem; padding: .9rem 1.2rem; }
  .ac-item .seat { font-size: .9rem; }
  .error-msg { padding: 2.5rem 1.2rem; }
  .error-msg .icon { font-size: 3.5rem; }
  .error-msg p { font-size: 1.1rem; }
  .loading { padding: 3.5rem 1.2rem; }
  .loading-spinner { width: 45px; height: 45px; }
  .loading p { font-size: 1.1rem; }
  /* Modal mobile styles - larger fonts */
  .modal-header h2 { font-size: 1.3rem; }
  .modal-body { padding: 1.3rem; }
  .pay-info-card { padding: 1.1rem; }
  .pay-info-card .card-title { font-size: 1.15rem; }
  .pay-info-row { font-size: 1.15rem; }
  .pay-info-row .lbl { font-size: 1.05rem; }
  .pay-info-row .val { font-size: 1.15rem; }
  .pay-info-row .val.mono { font-size: 1.1rem; }
  .pay-deadline { font-size: 1.2rem; padding: 1.1rem; }
  .btn-primary { font-size: 1.15rem; padding: 1.15rem; }
  .btn-outline { font-size: 1.05rem; padding: 1rem; }
  .form-label { font-size: 1rem; }
  .form-input, .form-select { font-size: 1.15rem; padding: 1rem 1.1rem; }
  .form-hint { font-size: .9rem; }
  .linepay-note { font-size: 1rem; padding: .9rem 1.1rem; }
  .reminder-banner { font-size: 1.1rem; padding: 1.1rem; }
  .step-indicator { margin-bottom: 1rem; }
  .step-dot { width: 32px; height: 32px; font-size: .85rem; }
  .success-icon { font-size: 4rem; }
  .success-screen h3 { font-size: 1.3rem; }
  .success-screen p { font-size: 1rem; }
}

@media (min-width: 481px) and (max-width: 768px) {
  .container { padding: 1.3rem .9rem 2.5rem; }
}

/* â”€â”€ Payment Modal â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(61,53,48,.45);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  animation: fadeIn .25s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal {
  background: var(--card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 440px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(217,119,87,.25);
  animation: modalUp .35s cubic-bezier(.4,0,.2,1);
  border: 2px solid var(--border-light);
}
@keyframes modalUp { from { opacity: 0; transform: translateY(40px) scale(.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
.modal-header {
  padding: 1.4rem 1.6rem;
  background: linear-gradient(135deg, #D97757 0%, #E8A88E 100%);
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 22px 22px 0 0;
  position: relative;
}
.modal-header::before {
  display: none;
}
.modal-header h2 {
  font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 2px;
  position: relative;
}
.modal-close {
  background: rgba(255,255,255,.25);
  border: none;
  color: #fff;
  width: 34px; height: 34px;
  border-radius: 50%;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
  position: relative;
}
.modal-close:hover { background: rgba(255,255,255,.4); transform: rotate(90deg); }
.modal-body { padding: 1.5rem 1.6rem; }
.modal-step { display: none; }
.modal-step.active { display: block; animation: fadeIn .2s ease; }

/* Pay info cards - side by side */
.pay-methods-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}
.pay-info-card {
  background: var(--bg-warm);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1.2rem;
  flex: 1;
  min-width: 0;
  transition: all var(--transition);
}
.pay-info-card .card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 1px;
  margin-bottom: 1rem;
  padding-bottom: .6rem;
  border-bottom: 2px dashed var(--border);
}
.pay-info-row {
  padding: .15rem 0;
  font-size: 1.1rem;
  line-height: 1.4;
}
.pay-info-row .lbl { color: var(--text-soft); font-weight: 500; font-size: .85rem; display: block; margin-bottom: -.1rem; }
.pay-info-row .val { font-weight: 700; color: var(--text); letter-spacing: .3px; display: block; font-size: 1.05rem; }
.pay-info-row .val.mono { font-family: var(--font-num); font-size: 1.05rem; word-break: break-all; color: var(--accent-dark); }
.pay-info-card.clickable {
  cursor: pointer;
  transition: all .25s ease;
  position: relative;
  border: 2px solid var(--koelr);
  background: var(--koelr-bg);
}
.pay-info-card.clickable::after {
  content: 'é»æ“ŠåŠ å¥½å‹ â†’';
  position: absolute;
  bottom: 10px;
  right: 10px;
  font-size: .7rem;
  color: var(--koelr);
  font-weight: 600;
}
.pay-info-card.clickable:hover {
  background: #dcedc8 !important;
  border-color: #4caf50 !important;
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 8px 24px rgba(76,175,80,.35);
}
.pay-info-card.clickable:active {
  transform: translateY(0) scale(1);
  background: #c8e6c9 !important;
}
@media (max-width: 480px) {
  .pay-methods-row { flex-direction: column; gap: .8rem; }
  .pay-info-card.clickable::after { font-size: .8rem; }
}
.pay-deadline {
  text-align: center;
  padding: 1.1rem;
  margin: 1rem 0;
  background: var(--unpaid-bg);
  border-radius: var(--radius-xs);
  font-size: 1.15rem;
  color: var(--unpaid);
  font-weight: 700;
  border: 2px solid rgba(196,100,90,.3);
}

/* Form fields */
.form-group { margin-bottom: 1.2rem; }
.form-label {
  display: block;
  font-size: .9rem;
  font-weight: 600;
  color: var(--text-soft);
  margin-bottom: .5rem;
}
.form-input, .form-select {
  width: 100%;
  padding: 1rem 1.2rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: 1.05rem;
  font-family: inherit;
  background: var(--bg-warm);
  color: var(--text);
  outline: none;
  transition: all var(--transition);
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(217,119,87,.15);
  background: var(--card);
}
.form-input:disabled { opacity: .5; }
.form-hint {
  font-size: .82rem;
  color: var(--text-muted);
  margin-top: .4rem;
  line-height: 1.6;
}
.form-input.readonly-info {
  background: var(--accent-light);
  border-color: var(--accent-soft);
  color: var(--text);
  font-weight: 600;
}
.linepay-note {
  background: var(--koelr-bg);
  border: 2px solid #c5d8b3;
  border-radius: var(--radius-xs);
  padding: 1rem 1.2rem;
  font-size: .95rem;
  color: var(--koelr);
  line-height: 1.7;
  margin-bottom: 1.2rem;
}

/* Buttons */
.btn-primary {
  width: 100%;
  padding: 1.1rem;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-size: 1.1rem;
  font-family: inherit;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 2px;
  transition: all var(--transition);
  box-shadow: 0 4px 16px rgba(217,119,87,.3);
}
.btn-primary:hover:not(:disabled) { 
  background: linear-gradient(135deg, var(--accent-dark) 0%, #A85540 100%); 
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(217,119,87,.4);
}
.btn-primary:active:not(:disabled) { transform: scale(.98) translateY(0); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }
.btn-outline {
  width: 100%;
  padding: 1rem;
  background: var(--card);
  color: var(--text-soft);
  border: 2px solid var(--border);
  border-radius: var(--radius-xs);
  font-size: 1rem;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  margin-top: .7rem;
  transition: all var(--transition);
}
.btn-outline:hover { background: var(--bg-warm); border-color: var(--accent-soft); color: var(--text); }

/* Step indicator */
.step-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: .6rem;
  margin-bottom: 1.2rem;
  font-size: .85rem;
  color: var(--text-muted);
}
.step-dot {
  width: 32px; height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .8rem;
  font-weight: 700;
  transition: all var(--transition);
}
.step-dot.active {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color: #fff;
  box-shadow: 0 4px 12px rgba(217,119,87,.3);
}
.step-dot.inactive {
  background: var(--border-light);
  color: var(--text-muted);
}
.step-line {
  width: 50px; height: 3px;
  background: var(--border);
  border-radius: 2px;
}

/* Reminder banner */
.reminder-banner {
  background: #FFF8F4;
  border: 2px solid #E8A88E;
  border-radius: var(--radius-xs);
  padding: 1rem 1.2rem;
  margin-bottom: 1.2rem;
  text-align: center;
  font-size: 1rem;
  font-weight: 700;
  color: #C0654A;
  line-height: 1.7;
  position: relative;
}
.reminder-banner::before {
  content: '';
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 8px solid #E8A88E;
}

/* Pulse animation for CTA */
@keyframes pulse {
  0% { box-shadow: 0 4px 16px rgba(217,119,87,.3), 0 0 0 0 rgba(217,119,87,.4); }
  70% { box-shadow: 0 4px 16px rgba(217,119,87,.3), 0 0 0 15px rgba(217,119,87,0); }
  100% { box-shadow: 0 4px 16px rgba(217,119,87,.3), 0 0 0 0 rgba(217,119,87,0); }
}
.btn-primary.pulse {
  animation: pulse 2s infinite;
}

/* Success screen */
.success-screen {
  text-align: center;
  padding: 2rem 0;
  background: var(--paid-bg);
  border-radius: var(--radius-sm);
  margin: -1rem;
  margin-bottom: 1rem;
  padding: 2.5rem 1.5rem;
}
.success-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  animation: bounce 1s ease infinite;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.success-screen h3 {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--paid);
  margin-bottom: .6rem;
}
.success-screen p {
  font-size: 1rem;
  color: var(--text-soft);
  line-height: 1.8;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>é¸ä¿®è²»ç”¨æŸ¥è©¢</h1>
    <p>è¼¸å…¥å­©å­çš„å§“åæˆ–åº§è™Ÿï¼ŒæŸ¥çœ‹è²»ç”¨æ˜ç´°</p>
  </div>
</div>

<div class="container">
  <div class="search-section">
    <div class="search-label">æœå°‹å­¸ç”Ÿ</div>
    <div class="search-row">
      <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="åº§è™Ÿæˆ–å§“å..." autocomplete="off" disabled>
        <div class="autocomplete-list" id="autocomplete"></div>
      </div>
      <button class="btn-search" onclick="doSearch()" disabled id="searchBtn">æŸ¥ è©¢</button>
    </div>
  </div>
  <div id="results">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
    </div>
  </div>
</div>

<div class="footer">ç­ç´šé¸ä¿®è²»ç”¨æŸ¥è©¢ç³»çµ±ã€€ã€€å’Œå¹³å¯¦é©—å°å­¸</div>

<script>
// ============================================================
// â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
// ============================================================
const SHEET_ID = '1Gqea_tTq_-Mvd8LfLbDKu9T5zB_vWB5pbQiYDgMidGE';
const SHEET_NAME = 'é¸ä¿®è²»';

// â˜… ç¹³è²»å›å ± Apps Script ç¶²å€ï¼ˆéƒ¨ç½²å¾Œè²¼åœ¨é€™è£¡ï¼‰
const SCRIPT_URL = 'åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Apps Script ç¶²å€';

// â˜… ç¹³è²»è³‡è¨Šï¼ˆæ¯å­¸å­£æ›´æ–°é€™è£¡å°±å¥½ï¼‰
const PAY_INFO = {
  bank: 'å°åŒ—å¯Œé‚¦ 012',
  branch: 'èŠæ•¬åˆ†è¡Œ',
  account: '00461168191348',
  accountName: 'æˆ´ä¾ä¾',
  linePayUrl: 'https://line.me/ti/p/7BYZ9G-oeF',
  linePay: 'è«‹å…ˆåŠ ã€Œæˆ´ä¾ä¾ã€ç‚ºå¥½å‹ï¼Œä¸¦å‘ŠçŸ¥æ˜¯å¹¾è™Ÿçš„å®¶é•·',
  deadline: '12/5',
};

// å·²å…¨éƒ¨ç¹³æ¸…çš„å­¸å­£ï¼ˆæ ¼å¼ï¼šã€Œå¹´ç´šå-å­¸å­£åã€ï¼‰
// é€™äº›å­¸å­£æ‰€æœ‰å­¸ç”Ÿéƒ½æœƒé¡¯ç¤ºã€Œå·²ç¹³ã€ï¼Œä¸éœ€è¦åœ¨è©¦ç®—è¡¨æ¨™è¨˜
const PAID_SEASONS = [
  "å±±æ«»ç­-ç§‹å­¸å­£",
  "å±±æ«»ç­-å†¬å­¸å­£",
  "å±±æ«»ç­-æ˜¥å­¸å­£",
  "å±±æ«»ç­-å¤å­¸å­£",
  "æ¬’æ¨¹ç­-ç§‹å­¸å­£",
  // "æ¬’æ¨¹ç­-å†¬å­¸å­£",  â† ç›®å‰é€™å­¸å­£ï¼Œé‚„æ²’ç¹³æ¸…æ‰€ä»¥ä¸åŠ 
];

// å¹´ç´šè¨­å®šï¼šç”¨æ¬„ä½å‰ç¶´ä¾†å€åˆ†å“ªäº›æ¬„å±¬æ–¼å“ªå€‹å¹´ç´š
// prefix: è©¦ç®—è¡¨æ¬„ä½é–‹é ­æ˜¯é€™äº›å­—çš„ï¼Œå°±æ­¸åˆ°é€™å€‹å¹´ç´š
const GRADE_CONFIG = [
  { name:"å±±æ«»ç­", grade:"ä¸‰å¹´ç´š", colorClass:"cherry",
    prefixes:["å±±ç§‹","å±±å†¬","å±±æ˜¥","å±±å¤","å±±æ«»"] },
  { name:"æ¬’æ¨¹ç­", grade:"å››å¹´ç´š", colorClass:"koelr",
    prefixes:["æ¬’ç§‹","æ¬’å†¬","æ¬’æ¨¹","æ¬’æ˜¥","æ¬’å¤"] },
  // æœªä¾†æ–°å¢ï¼ˆæŠŠè¨»è§£æ‹¿æ‰å°±å¥½ï¼‰ï¼š
  // { name:"æœ¨æ£‰ç­", grade:"äº”å¹´ç´š", colorClass:"cotton",
  //   prefixes:["æœ¨ç§‹","æœ¨å†¬","æœ¨æ˜¥","æœ¨å¤","æœ¨æ£‰"] },
  // { name:"æ¥“é¦™ç­", grade:"å…­å¹´ç´š", colorClass:"maple",
  //   prefixes:["æ¥“ç§‹","æ¥“å†¬","æ¥“æ˜¥","æ¥“å¤","æ¥“é¦™"] },
];
// ============================================================

const SEASON_MAP = {"ç§‹":"ğŸ‚","å†¬":"â„ï¸","æ˜¥":"ğŸŒ¸","å¤":"â˜€ï¸"};
function getSeasonIcon(name) {
  for (const [k,v] of Object.entries(SEASON_MAP)) { if (name.includes(k)) return v; }
  return "ğŸ“˜";
}

// åˆ¤æ–·ä¸€å€‹æ¬„ä½å±¬æ–¼å“ªå€‹å¹´ç´š
function matchGrade(colName) {
  // ä¾ prefix é•·åº¦ç”±é•·åˆ°çŸ­æ¯”å°ï¼Œé¿å…ã€Œç§‹ã€èª¤é…ã€Œæ¬’ç§‹ã€
  for (const g of [...GRADE_CONFIG].sort((a,b) => {
    const maxA = Math.max(...a.prefixes.map(p=>p.length));
    const maxB = Math.max(...b.prefixes.map(p=>p.length));
    return maxB - maxA;
  })) {
    for (const p of g.prefixes.sort((a,b)=>b.length-a.length)) {
      if (colName.startsWith(p)) return g;
    }
  }
  return null;
}

// å¾æ¬„ä½ååˆ¤æ–·å­£ç¯€å
function getSeasonName(colName, gradeConfig) {
  // "æ¬’ç§‹-æ‰‹ä½œ" â†’ æ‰¾åˆ° prefix "æ¬’ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "ç§‹" â†’ å­£ç¯€æ˜¯ "ç§‹å­¸å­£"
  // "æ˜¥-ç¥è¾²æ°" â†’ å­£ç¯€æ˜¯ "æ˜¥å­¸å­£"
  for (const p of gradeConfig.prefixes.sort((a,b)=>b.length-a.length)) {
    if (colName.startsWith(p)) {
      // å–å‡ºå­£ç¯€å­—ï¼šæœ€å¾Œä¸€å€‹å­—
      const lastChar = p.slice(-1);
      for (const s of Object.keys(SEASON_MAP)) {
        if (lastChar === s || p.includes(s)) return s + "å­¸å­£";
      }
      return p + "å­¸å­£";
    }
  }
  return "å…¶ä»–";
}

// å–å¾—èª²ç¨‹é¡¯ç¤ºåç¨±
function getCourseName(colName) {
  const dash = colName.indexOf('-');
  if (dash >= 0) return colName.substring(dash + 1);
  return colName + "é¸ä¿®";
}

let allStudents = [];
let dataReady = false;

// å¾ã€Œç¹³è²»å›å ±ã€é ç±¤ G1 è®€å–ç¹³è²»æˆªæ­¢æ—¥
async function fetchDeadline() {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent('ç¹³è²»å›å ±')}&range=G1`;
    const res = await fetch(url);
    const text = await res.text();
    const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
    if (jsonStr) {
      const json = JSON.parse(jsonStr[1]);
      const val = json.table?.rows?.[0]?.c?.[0]?.v;
      if (val) PAY_INFO.deadline = String(val).trim();
    }
  } catch (e) {
    // è®€ä¸åˆ°å°±ç”¨é è¨­å€¼ï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½
  }
}

async function fetchSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
  if (!jsonStr) throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨è³‡æ–™ï¼Œè«‹ç¢ºèªåˆ†äº«è¨­å®š');
  return JSON.parse(jsonStr[1]);
}

function parseData(json) {
  const cols = json.table.cols.map(c => (c.label || '').trim());
  const rows = json.table.rows;

  const seatIdx = cols.findIndex(c => c.includes('åº§è™Ÿ'));
  const nameIdx = cols.findIndex(c => c.includes('å§“å'));
  if (seatIdx === -1 || nameIdx === -1) throw new Error('æ‰¾ä¸åˆ°ã€Œåº§è™Ÿã€æˆ–ã€Œå§“åã€æ¬„ä½');

  // åˆ†ææ¯å€‹æ¬„ä½æ­¸å±¬
  // colInfo[i] = { grade, seasonName, courseName, isPaid, colIdx }
  const colInfos = [];
  let lastDataCol = null; // è¿½è¹¤ã€Œå·²ç¹³æ¬¾ã€å°æ‡‰çš„å‰ä¸€å€‹è³‡æ–™æ¬„

  for (let i = 0; i < cols.length; i++) {
    const col = cols[i];
    if (i === seatIdx || i === nameIdx || !col) continue;

    if (col === 'å·²ç¹³æ¬¾') {
      // æ¨™è¨˜å‰ä¸€å€‹å­¸å­£çš„ paid æ¬„ä½
      if (lastDataCol) lastDataCol.paidIdx = i;
      continue;
    }
    if (col.includes('ç¸½é¡') || col.includes('é¸ä¿®è²»')) {
      continue; // è·³éå°è¨ˆæ¬„
    }

    const grade = matchGrade(col);
    if (!grade) continue;

    const seasonName = getSeasonName(col, grade);
    const courseName = getCourseName(col);

    const info = { grade: grade, seasonName, courseName, colIdx: i, paidIdx: -1 };
    colInfos.push(info);
    lastDataCol = info;
  }

  // çµ„ç¹”æˆ grade â†’ season â†’ courses çµæ§‹
  const students = [];

  for (const row of rows) {
    const cells = row.c || [];
    const seatVal = cells[seatIdx]?.v;
    const nameVal = cells[nameIdx]?.v;
    if (!seatVal || !nameVal) continue;
    if (typeof seatVal === 'string' && seatVal.includes('å…¥ç­è²»')) continue;
    const seat = Math.round(Number(seatVal));
    if (isNaN(seat)) continue;

    // å»ºç«‹æ¯å€‹å¹´ç´šçš„è³‡æ–™
    const grades = [];
    for (const gc of GRADE_CONFIG) {
      const myCols = colInfos.filter(c => c.grade === gc);
      if (myCols.length === 0) continue;

      // åˆ†çµ„æˆå­¸å­£
      const seasonMap = {};
      for (const ci of myCols) {
        if (!seasonMap[ci.seasonName]) {
          seasonMap[ci.seasonName] = { name: ci.seasonName, icon: getSeasonIcon(ci.seasonName), courses: [], paidIdx: -1 };
        }
        const amount = Number(cells[ci.colIdx]?.v) || 0;
        seasonMap[ci.seasonName].courses.push({ label: ci.courseName, amount });
        if (ci.paidIdx >= 0) seasonMap[ci.seasonName].paidIdx = ci.paidIdx;
      }

      const seasons = Object.values(seasonMap).map(sn => {
        const total = sn.courses.reduce((a, c) => a + c.amount, 0);
        const paid = sn.paidIdx >= 0 ? (cells[sn.paidIdx]?.v === 'v' ? 'v' : '') : null;
        return { ...sn, total, paid };
      });

      grades.push({ name: gc.name, grade: gc.grade, colorClass: gc.colorClass, seasons });
    }

    students.push({ seat, name: nameVal, grades });
  }

  return students;
}

async function loadAllData() {
  const resultsDiv = document.getElementById('results');
  try {
    const json = await fetchSheet();
    allStudents = parseData(json);
    dataReady = true;
    await fetchDeadline(); // å¾è©¦ç®—è¡¨è®€å–æˆªæ­¢æ—¥

    document.getElementById('searchInput').disabled = false;
    document.getElementById('searchBtn').disabled = false;

    const now = new Date();
    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

    resultsDiv.innerHTML = `
      <div class="status-bar"><span><span class="status-dot ok"></span>è³‡æ–™å·²è¼‰å…¥ï¼ˆ${allStudents.length} ä½å­¸ç”Ÿï¼‰</span><span>æ›´æ–°ï¼š${timeStr}</span></div>
      <div class="hint"><div class="hint-icon">ğŸ”</div><p>è¼¸å…¥å°æœ‹å‹çš„å§“åæˆ–åº§è™Ÿ<br>å³å¯æŸ¥çœ‹å„å­¸å­£çš„é¸ä¿®è²»ç”¨æ˜ç´°</p></div>`;
  } catch (err) {
    resultsDiv.innerHTML = `
      <div class="error-msg"><div class="icon">âš ï¸</div>
        <p>è¼‰å…¥è³‡æ–™å¤±æ•—</p>
        <p style="margin-top:.8rem;font-size:.82rem;line-height:1.6">è«‹ç¢ºèªï¼š<br>1. è©¦ç®—è¡¨å·²è¨­å®šã€ŒçŸ¥é“é€£çµçš„äººå¯ä»¥æª¢è¦–ã€<br>2. é ç±¤åç¨±ç‚ºã€Œ${SHEET_NAME}ã€</p>
        <p style="margin-top:.8rem;font-size:.75rem;color:#bbb">${err.message}</p>
      </div>`;
  }
}

// === æœå°‹ ===
const searchInput = document.getElementById('searchInput');
const acList = document.getElementById('autocomplete');
const resultsDiv = document.getElementById('results');

// è™•ç†ä¸­æ–‡è¼¸å…¥æ³•ï¼ˆæ³¨éŸ³/æ‹¼éŸ³ï¼‰çš„çµ„å­—ç‹€æ…‹
let isComposing = false;
searchInput.addEventListener('compositionstart', () => { isComposing = true; });
searchInput.addEventListener('compositionend', () => {
  isComposing = false;
  triggerSearch(); // çµ„å­—å®Œæˆå¾Œç«‹å³æœå°‹
});

function triggerSearch() {
  if (!dataReady) return;
  const q = searchInput.value.trim();
  if (!q) { acList.classList.remove('show'); return; }
  const m = allStudents.filter(x => x.name.includes(q) || String(x.seat) === q || String(x.seat).startsWith(q)).slice(0, 8);
  if (!m.length) { acList.classList.remove('show'); return; }
  acList.innerHTML = m.map(x => `<div class="ac-item" data-seat="${x.seat}" data-name="${x.name}"><span>${x.name}</span><span class="seat">åº§è™Ÿ ${x.seat}</span></div>`).join('');
  acList.classList.add('show');
}

searchInput.addEventListener('input', () => {
  if (isComposing) return; // çµ„å­—ä¸­å…ˆä¸æœå°‹
  triggerSearch();
});

acList.addEventListener('click', e => {
  const item = e.target.closest('.ac-item');
  if (!item) return;
  searchInput.value = item.dataset.name;
  acList.classList.remove('show');
  const x = allStudents.find(s => s.seat === Number(item.dataset.seat) && s.name === item.dataset.name);
  if (x) render(x);
});

// æ‰‹æ©Ÿè§¸æ§æ”¯æ´
acList.addEventListener('touchend', e => {
  const item = e.target.closest('.ac-item');
  if (!item) return;
  e.preventDefault();
  searchInput.value = item.dataset.name;
  acList.classList.remove('show');
  const x = allStudents.find(s => s.seat === Number(item.dataset.seat) && s.name === item.dataset.name);
  if (x) render(x);
});

searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
document.addEventListener('click', e => { if (!e.target.closest('.search-wrapper')) acList.classList.remove('show'); });

function doSearch() {
  if (!dataReady) return;
  acList.classList.remove('show');
  const q = searchInput.value.trim();
  if (!q) return;
  const x = allStudents.find(s => s.name === q || String(s.seat) === q) || allStudents.find(s => s.name.includes(q));
  if (x) render(x);
  else resultsDiv.innerHTML = `<div class="error-msg"><div class="icon">ğŸ˜•</div><p>æ‰¾ä¸åˆ°ã€Œ${q}ã€ï¼Œè«‹ç¢ºèªå§“åæˆ–åº§è™Ÿ</p></div>`;
}

function render(x) {
  let gt = 0;
  let latestSeason = null; // æœ€æ–°å­¸å­£
  const html = x.grades.map(g => {
    let gTotal = 0;
    const shtml = g.seasons.map(sn => {
      const active = sn.courses.filter(c => c.amount > 0);
      gTotal += sn.total; gt += sn.total;
      const seasonKey = g.name + '-' + sn.name;
      const forcePaid = PAID_SEASONS.includes(seasonKey);
      const isPaid = forcePaid || sn.paid === 'v';
      // è¨˜éŒ„æœ€æ–°çš„å­¸å­£ï¼ˆä¸è«–é‡‘é¡æ˜¯å¦ç‚º 0ï¼Œéƒ½è¦æ›´æ–°ï¼‰
      latestSeason = { gradeName: g.name, seasonName: sn.name, total: sn.total };
      const showPaidTag = sn.total > 0 ? (isPaid ? '<span class="season-paid paid-yes">âœ“ å·²ç¹³</span>' : '<span class="season-paid paid-no">æœªç¹³</span>') : '';
      return `<div class="season-group"><div class="season-header" onclick="tog(this)"><div class="season-title"><span class="season-icon">${sn.icon}</span>${sn.name}${showPaidTag}</div><div class="season-right"><span class="season-total">${sn.total > 0 ? '$' + sn.total.toLocaleString() : '-'}</span><span class="chevron">â–¼</span></div></div><div class="season-details">${active.length > 0 ? active.map(c => `<div class="course-row"><span class="course-name">${c.label}</span><span class="course-amount">$${c.amount.toLocaleString()}</span></div>`).join('') : '<div class="no-course">æœ¬å­¸å­£ç„¡é¸ä¿®è²»ç”¨</div>'}</div></div>`;
    }).join('');
    return `<div class="grade-section"><div class="grade-header ${g.colorClass}"><span class="grade-dot ${g.colorClass}"></span>${g.name}ï¼ˆ${g.grade}ï¼‰<span class="grade-subtotal">${gTotal > 0 ? 'å°è¨ˆ $' + gTotal.toLocaleString() : ''}</span></div>${shtml}</div>`;
  }).join('');
  // é¡¯ç¤ºæœ€æ–°å­¸å­£é‡‘é¡ï¼šé‡‘é¡ç‚º 0 æ™‚é¡¯ç¤ºã€Œæœ¬å­¸å­£ç„¡éœ€ç¹³è²»ã€ï¼Œä¸é¡¯ç¤ºç¹³è²»æŒ‰éˆ•
  let bannerHtml = '';
  let payBtnHtml = '';
  if (latestSeason) {
    if (latestSeason.total > 0) {
      bannerHtml = `<div class="total-banner"><span class="label">${latestSeason.gradeName} ${latestSeason.seasonName} æ‡‰ç¹³é‡‘é¡</span><span class="amount">$${latestSeason.total.toLocaleString()}</span></div>`;
      payBtnHtml = `<div class="pay-btn-wrap"><button class="pay-btn" onclick="openPayModal('${x.name}', ${x.seat})">ğŸ’³ ç¹³è²»æ–¹å¼</button></div>`;
    } else {
      bannerHtml = `<div class="total-banner"><span class="label">${latestSeason.gradeName} ${latestSeason.seasonName}</span><span class="amount" style="color:var(--paid)">æœ¬å­¸å­£ç„¡éœ€ç¹³è²»</span></div>`;
    }
  }
  resultsDiv.innerHTML = `<div class="student-card"><div class="student-header"><span class="student-name">${x.name}</span><span class="student-seat">åº§è™Ÿ ${x.seat}</span></div>${bannerHtml}${payBtnHtml}${html}</div>`;
}

function tog(el) { el.nextElementSibling.classList.toggle('open'); el.querySelector('.chevron').classList.toggle('open'); }

loadAllData();

// ============================================================
// â˜…â˜…â˜… ç¹³è²»å›å ±å½ˆçª— â˜…â˜…â˜…
// ============================================================

let currentStudent = { name: '', seat: 0 };

function openPayModal(name, seat) {
  currentStudent = { name, seat };
  // å»ºç«‹ modal HTML
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'payModal';
  overlay.onclick = function(e) { if (e.target === overlay) closePayModal(); };

  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ’³ é¸æ“‡ç¹³è²»æ–¹å¼</h2>
        <button class="modal-close" onclick="closePayModal()">âœ•</button>
      </div>
      <div class="modal-body">

        <!-- æ­¥é©Ÿä¸€ï¼šé¡¯ç¤ºç¹³è²»è³‡è¨Š -->
        <div class="modal-step active" id="stepInfo">
          <div class="step-indicator">
            <span class="step-dot active">1</span>
            <span class="step-line"></span>
            <span class="step-dot inactive">2</span>
          </div>
          <div class="reminder-banner">
            âš ï¸ è½‰å¸³å®Œæˆå¾Œï¼Œè«‹å‹™å¿…å›ä¾†<br>é»ä¸‹æ–¹ã€Œæˆ‘å·²ç¹³è²»ã€æŒ‰éˆ•å›å ±ï¼
          </div>
          <div class="pay-methods-row">
            <div class="pay-info-card">
              <div class="card-title">ğŸ¦ éŠ€è¡Œè½‰å¸³</div>
              <div class="pay-info-row"><span class="lbl">éŠ€è¡Œ</span><span class="val">${PAY_INFO.bank}</span></div>
              <div class="pay-info-row"><span class="lbl">åˆ†è¡Œ</span><span class="val">${PAY_INFO.branch}</span></div>
              <div class="pay-info-row"><span class="lbl">å¸³è™Ÿ</span><span class="val mono">${PAY_INFO.account}</span></div>
              <div class="pay-info-row"><span class="lbl">æˆ¶å</span><span class="val">${PAY_INFO.accountName}</span></div>
            </div>
            <div class="pay-info-card clickable" onclick="window.open('${PAY_INFO.linePayUrl}','_blank')">
              <div class="card-title">ğŸ’š LINE PAY</div>
              <div style="font-size:1.05rem;color:var(--text-soft);line-height:1.8">
                ğŸ‘‰ é»æ­¤åŠ å¥½å‹<br>
                æˆ¶åï¼š${PAY_INFO.accountName}<br>
                åŠ å¥½å‹å¾Œè«‹å‘ŠçŸ¥<br>æ˜¯å¹¾è™Ÿçš„å®¶é•·
              </div>
            </div>
          </div>
          <div class="pay-deadline">â° ç¹³è²»æˆªæ­¢æ—¥ï¼š${PAY_INFO.deadline}</div>
          <button class="btn-primary pulse" onclick="goToStep('stepForm')">âœ… å·²ç¹³è²»ï¼Œä¸‹ä¸€æ­¥å¡«å¯«å›å ± â†’</button>
          <button class="btn-outline" onclick="closePayModal()">é‚„æ²’ç¹³è²»ï¼Œç¨å¾Œå†ä¾†</button>
        </div>

        <!-- æ­¥é©ŸäºŒï¼šç¹³è²»å›å ±è¡¨å–® -->
        <div class="modal-step" id="stepForm">
          <div class="step-indicator">
            <span class="step-dot inactive">âœ“</span>
            <span class="step-line"></span>
            <span class="step-dot active">2</span>
          </div>
          <div class="form-group">
            <label class="form-label">å­¸ç”Ÿå§“å</label>
            <input class="form-input readonly-info" type="text" value="${name}ï¼ˆåº§è™Ÿ ${seat}ï¼‰" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
            <select class="form-select" id="payMethod" onchange="onMethodChange()">
              <option value="">è«‹é¸æ“‡...</option>
              <option value="å¯Œé‚¦è½‰å¸³">å¯Œé‚¦éŠ€è¡Œè½‰å¸³</option>
              <option value="LinePay">LINE Pay</option>
            </select>
          </div>
          <div class="form-group" id="lastFiveGroup" style="display:none">
            <label class="form-label">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
            <input class="form-input" type="text" id="lastFive" placeholder="è«‹è¼¸å…¥å¾Œäº”ç¢¼" maxlength="5" inputmode="numeric">
            <div class="form-hint">æ–¹ä¾¿è€å¸«æ ¸å°æ¬¾é …</div>
          </div>
          <div id="linePayNote" style="display:none">
            <div class="linepay-note">
              ğŸ“± ä½¿ç”¨ LINE Pay ç¹³è²»è«‹æ³¨æ„ï¼š<br>
              1. <a href="${PAY_INFO.linePayUrl}" target="_blank" style="color:var(--koelr);font-weight:600">é»æ­¤åŠ ã€Œ${PAY_INFO.accountName}ã€ç‚ºå¥½å‹</a><br>
              2. è½‰å¸³æ™‚è«‹åœ¨è¨Šæ¯å‚™è¨»ã€Œ<strong>${seat}è™Ÿ ${name}</strong>ã€
            </div>
          </div>
          <button class="btn-primary" id="submitBtn" onclick="submitReport()" disabled>é€å‡ºç¹³è²»å›å ±</button>
          <button class="btn-outline" onclick="goToStep('stepInfo')">â† è¿”å›</button>
        </div>

        <!-- æ­¥é©Ÿä¸‰ï¼šæˆåŠŸç•«é¢ -->
        <div class="modal-step" id="stepSuccess">
          <div class="success-screen">
            <div class="success-icon">ğŸ‰</div>
            <h3>ç¹³è²»å›å ±å·²é€å‡ºï¼</h3>
            <p>æœƒè¨ˆæœƒå„˜å¿«ç¢ºèªæ‚¨çš„ç¹³è²»ç´€éŒ„<br>æ„Ÿè¬æ‚¨çš„é…åˆ âœ¨</p>
          </div>
          <button class="btn-primary" onclick="closePayModal()" style="margin-top:1rem">é—œé–‰</button>
        </div>

      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  document.body.style.overflow = 'hidden';
}

function closePayModal() {
  const modal = document.getElementById('payModal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

function goToStep(stepId) {
  document.querySelectorAll('#payModal .modal-step').forEach(s => s.classList.remove('active'));
  document.getElementById(stepId).classList.add('active');
}

function onMethodChange() {
  const method = document.getElementById('payMethod').value;
  const lastFiveGroup = document.getElementById('lastFiveGroup');
  const linePayNote = document.getElementById('linePayNote');
  const submitBtn = document.getElementById('submitBtn');

  if (method === 'å¯Œé‚¦è½‰å¸³') {
    lastFiveGroup.style.display = 'block';
    linePayNote.style.display = 'none';
    submitBtn.disabled = false;
  } else if (method === 'LinePay') {
    lastFiveGroup.style.display = 'none';
    linePayNote.style.display = 'block';
    submitBtn.disabled = false;
  } else {
    lastFiveGroup.style.display = 'none';
    linePayNote.style.display = 'none';
    submitBtn.disabled = true;
  }
}

async function submitReport() {
  const btn = document.getElementById('submitBtn');
  const method = document.getElementById('payMethod').value;
  const lastFive = method === 'å¯Œé‚¦è½‰å¸³' ? (document.getElementById('lastFive').value.trim()) : 'ï¼ˆLINE Payï¼‰';

  if (!method) return;

  // å¯Œé‚¦è½‰å¸³éœ€è¦å¾Œäº”ç¢¼
  if (method === 'å¯Œé‚¦è½‰å¸³' && !lastFive) {
    alert('è«‹å¡«å¯«åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼');
    return;
  }
  if (method === 'å¯Œé‚¦è½‰å¸³' && !/^\d{5}$/.test(lastFive)) {
    alert('å¾Œäº”ç¢¼è«‹å¡« 5 ä½æ•¸å­—');
    return;
  }

  // é˜²é‡è¤‡é€å‡º
  btn.disabled = true;
  btn.textContent = 'é€å‡ºä¸­...';

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        seat: currentStudent.seat,
        name: currentStudent.name,
        method: method,
        lastFive: lastFive,
      })
    });

    // no-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–å›æ‡‰ï¼Œç›´æ¥ç•¶ä½œæˆåŠŸ
    goToStep('stepSuccess');

  } catch (err) {
    alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤ï¼š' + err.message);
    btn.disabled = false;
    btn.textContent = 'é€å‡ºç¹³è²»å›å ±';
  }
}
</script>
</body>
</html>
